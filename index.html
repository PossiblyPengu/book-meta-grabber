<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, viewport-fit=cover, user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<title>Meta Grabber</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Figtree:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<style>
/* Modern UI Refresh - Enhanced Design System */
:root {
  --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  
  /* Enhanced color palette with better contrast and modern appeal */
  --g-bg: #0a0e1a;          /* deeper, richer background */
  --g-surface: #0f1419;     /* slightly warmer surface */
  --g-elev: #141923;        /* elevated surface with more depth */
  --g-bg-elevated: #1a1f2e; /* more prominent card background */
  --g-bg-h: rgba(255,255,255,0.04);
  --g-border: rgba(255,255,255,0.08);
  
  /* Modern accent colors with gradient support */
  --accent: #6366f1;        /* modern indigo accent */
  --accent-light: #818cf8;
  --accent-dark: #4f46e5;
  --blue: #60a5fa;
  --blue-light: #93c5fd;
  --purple: #a78bfa;
  --pink: #f472b6;
  --emerald: #34d399;
  
  /* Enhanced text hierarchy */
  --t1: #f8fafc;            /* crisp primary text */
  --t2: #cbd5e1;            /* softer secondary text */
  --t3: #94a3b8;            /* elegant muted text */
  --t4: #64748b;            /* subtle placeholder text */
  
  /* Semantic colors */
  --success: #10b981;
  --warning: #f59e0b;
  --error: #ef4444;
  --info: #3b82f6;
  /* Enhanced spacing and typography */
  --safe-top: calc(env(safe-area-inset-top, 16px) + 6px);
  --safe-bottom: calc(env(safe-area-inset-bottom, 12px) + 6px);
  --tab-h: calc(56px + var(--safe-bottom));
  
  /* Modern radii and sizing system */
  --r-xs: 4px; --r-sm: 6px; --r-md: 8px; --r-lg: 12px; --r-xl: 16px; --r-2xl: 20px; --r-pill: 999px;
  --touch: 48px;
  --card-gap: 16px;
  --base-font-size: clamp(15px, 1.4vw + 12px, 18px);
  --card-radius: 16px;
  --card-padding: 16px;
  
  /* Enhanced visual effects */
  --sheen: linear-gradient(135deg, rgba(255,255,255,0.06), rgba(255,255,255,0.01));
  --blur-s: blur(8px);
  --blur-m: blur(12px);
  --elev-shadow: 0 10px 40px rgba(0,0,0,0.4), 0 2px 10px rgba(0,0,0,0.3);
  --muted-shadow: 0 4px 20px rgba(0,0,0,0.3), 0 1px 4px rgba(0,0,0,0.2);
  --glow-shadow: 0 0 20px rgba(99,102,241,0.3);
  --transition-fast: .15s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-smooth: .25s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-bounce: .44s cubic-bezier(0.34, 1.3, 0.64, 1.1);
  --transition-modal: .3s cubic-bezier(0.34, 1.1, 0.64, 1);
  --transition-slide: .45s cubic-bezier(0.34, 1.1, 0.64, 1);
  --transition-tab: .28s cubic-bezier(0.34, 1.2, 0.64, 1);
  
  /* Modern gradients */
  --gradient-primary: linear-gradient(135deg, var(--accent), var(--accent-dark));
  --gradient-surface: linear-gradient(135deg, var(--g-surface), var(--g-elev));
  --gradient-card: linear-gradient(135deg, var(--g-bg-elevated), var(--g-elev));
  --gradient-accent: linear-gradient(135deg, var(--accent-light), var(--accent));
}

/* Modern component styling with enhanced visual hierarchy */
.glass, .gbar, .bsheet, .enav, .hero, .src-opt, .fcard, .tab-bar {
  background: var(--gradient-surface);
  border: 1px solid var(--g-border);
  box-shadow: var(--elev-shadow);
  backdrop-filter: none; -webkit-backdrop-filter: none;
  transition: all var(--transition-smooth);
}

.gbtn, .fpill, .schip, .fmt-epub, .fmt-pdf, .fmt-mp3 { 
  border-radius: var(--r-lg); 
  transition: all var(--transition-fast);
}

.bcard {
  background: var(--gradient-card);
  box-shadow: var(--muted-shadow);
  border-radius: var(--card-radius);
  border: 1px solid var(--g-border);
  transition: all var(--transition-smooth);
  position: relative;
  overflow: hidden;
}

.bcard::before {
  content: '';
  position: absolute;
  inset: 0;
  background: var(--sheen);
  opacity: 0;
  transition: opacity var(--transition-fast);
  pointer-events: none;
}

.bcard:hover::before {
  opacity: 1;
}

.hero {
  background: linear-gradient(135deg, rgba(6,10,18,0.92), rgba(10,14,22,0.95));
  box-shadow: var(--elev-shadow);
  border: 1px solid var(--g-border);
}

.enav {
  background: transparent;
}

.enav .enav-back {
  background: var(--gradient-surface);
  box-shadow: var(--muted-shadow);
  border: 1px solid var(--g-border);
}
/* Different defaults when launched from Home Screen (standalone) vs browser */
html.standalone{ --safe-top: calc(env(safe-area-inset-top, 18px) + 12px); --safe-bottom: calc(env(safe-area-inset-bottom, 12px) + 12px); }
html.browser{ --safe-top: calc(env(safe-area-inset-top, 10px) + 6px); --safe-bottom: calc(env(safe-area-inset-bottom, 6px) + 6px); }
/* Enhanced global styles with modern typography */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

html,body{
  width:100%;
  height:100%;
  overflow:auto;
  font-family:var(--font);
  color:var(--t1);
  font-size:var(--base-font-size);
  line-height:1.6;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  font-feature-settings:"kern" 1, "liga" 1;
  background:var(--g-bg);
  overscroll-behavior:none;
}

/* Enhanced mobile behavior */
html, body { 
  -webkit-text-size-adjust:100%; 
  -ms-text-size-adjust:100%; 
  touch-action: manipulation; 
}

/* Modern scrollbar styling */
::-webkit-scrollbar{width:8px}
::-webkit-scrollbar-track{background:var(--g-surface)}
::-webkit-scrollbar-thumb{
  background:var(--g-border);
  border-radius:var(--r-pill);
  transition: background var(--transition-fast);
}
::-webkit-scrollbar-thumb:hover{background:var(--t3)}
*{scrollbar-width:thin;scrollbar-color:var(--g-border) var(--g-surface)}

/* Ambient glassmorphism background */
.bg{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden;background:var(--g-bg)}
.orb,.noise{display:none}
@keyframes d1{0%,100%{transform:translate(0,0) scale(1)}40%{transform:translate(65px,95px) scale(1.13)}70%{transform:translate(-35px,55px) scale(.97)}}
@keyframes d2{0%,100%{transform:translate(0,0)}55%{transform:translate(-95px,115px) scale(1.18)}}
@keyframes d3{0%,100%{transform:translate(0,0)}45%{transform:translate(105px,-65px)}80%{transform:translate(45px,40px)}}
@keyframes d4{0%,100%{transform:translate(0,0) scale(1)}60%{transform:translate(-75px,-90px) scale(1.22)}}

/* Enhanced animations and micro-interactions */
@keyframes fade-up{from{opacity:0;transform:translateY(24px) scale(.97);}to{opacity:1;transform:translateY(0) scale(1);}}
@keyframes slide-up{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.7;}}
@keyframes shimmer{0%{background-position: -200% 0;}100%{background-position: 200% 0;}}
@keyframes spring-in{0%{transform:scale(.96);opacity:0;}60%{transform:scale(1.04);opacity:1;}100%{transform:scale(1);opacity:1;}}
@keyframes modal-in{from{opacity:0;transform:scale(0.92) translateY(10px);}to{opacity:1;transform:scale(1) translateY(0);}}
@keyframes ptr-rotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}

.fu{animation:fade-up var(--transition-bounce) both;will-change:transform,opacity;}
.bcard.fu{animation:spring-in var(--transition-bounce) both;contain:layout style paint;}
.bcard{transition:all var(--transition-smooth);will-change:transform,box-shadow;contain:layout style paint;}
.tab-bar{transition:all var(--transition-smooth);will-change:transform,background;contain:layout style paint;}
.hero{transition:all var(--transition-smooth);will-change:box-shadow,border-radius;contain:layout style paint;}

/* Enhanced loading states */
.loading::after {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
  animation: shimmer 1.5s infinite;
  border-radius: inherit;
}

/* Enhanced focus states */
.gbtn:focus-visible,
.ibtn:focus-visible,
.tbtn:focus-visible,
.finput:focus-visible {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}

/* Enhanced selection states */
::selection {
  background: rgba(99,102,241,0.3);
  color: var(--t1);
}

::-moz-selection {
  background: rgba(99,102,241,0.3);
  color: var(--t1);
}

/* Subtle hover effects for interactive elements */
.gbtn:hover,
.ibtn:hover,
.tbtn:hover,
.fpill:hover,
.schip:hover,
.src-opt:hover {
  -webkit-tap-highlight-color: transparent;
}

/* Enhanced transitions for smooth interactions */
* {
  -webkit-tap-highlight-color: transparent;
}

/* Elastic pull-to-refresh (visual only) */
@media (hover: none) and (pointer: coarse) {
  .book-grid:active {
    animation: elastic-pull .7s cubic-bezier(.34,1.6,.64,1.1);
  }
}

@keyframes elastic-pull {
  0% { transform: translateY(0); }
  30% { transform: translateY(18px) scaleY(1.04); }
  60% { transform: translateY(-8px) scaleY(.98); }
  100% { transform: translateY(0); }
}

/* Enhanced empty state animation */
.empty-icon {
  animation: pulse 2s infinite;
}

/* Smooth scroll behavior */
html {
  scroll-behavior: smooth;
}

/* Enhanced backdrop blur for better depth */
.backdrop {
  backdrop-filter: blur(12px) saturate(180%);
  -webkit-backdrop-filter: blur(12px) saturate(180%);
}

/* Enhanced modal animations */
.confirm-modal.show {
  animation: modal-in var(--transition-modal) both;
}

/* Glass containers and overlays */
.glass{position:relative;background:var(--g-surface);border-radius:var(--card-radius);overflow:hidden;border:1px solid var(--g-border);box-shadow:0 6px 18px rgba(0,0,0,0.5);}
.glass::before{display:none}
.gbar{background:var(--g-elev);border-radius:var(--card-radius);border:1px solid var(--g-border);box-shadow:0 6px 18px rgba(0,0,0,0.45)}

.sbpad{height:var(--safe-top);position:relative;z-index:1;flex-shrink:0;background:rgba(255,255,255,0.08);backdrop-filter:blur(6px);}
/* simplify top safe area */
.sbpad{background:transparent}

/* ...existing code... */
.tab-screen{position:fixed;inset:0;bottom:var(--tab-h);z-index:1;display:flex;
  flex-direction:column;opacity:0;transform:translateY(10px);pointer-events:none;
  transition:opacity var(--transition-tab),transform var(--transition-tab);contain:layout style paint;}
.tab-screen.active{opacity:1;transform:translateY(0);pointer-events:auto}

/* Ensure top-level screens leave room for status bar / dynamic island */
.tab-screen, .editor-scr{padding-top:var(--safe-top)}
.scr-hdr{padding-top:calc(var(--safe-top) - 6px)}
.hero{padding-top:calc(var(--safe-top) + 8px)}

/* ── Screen header ── */
.scr-hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;
  border-radius:0;border-left:none;border-right:none;border-top:none;flex-shrink:0}
/* Header title */
.scr-title{font-size:36px;font-weight:800;letter-spacing:-.8px;font-family:var(--font);color:var(--t1);}
/* Header actions */
.hdr-actions{display:flex;gap:16px;align-items:center;}

/* ── Enhanced Icon Button ── */
.ibtn{
  width:var(--touch);
  height:var(--touch);
  border-radius:var(--r-lg);
  border:none;
  background:transparent;
  color:var(--t1);
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:all var(--transition-fast);
  position:relative;
  overflow:hidden;
  font-size:20px;
}

.ibtn::before {
  content: '';
  position: absolute;
  inset: 0;
  background: var(--gradient-accent);
  opacity: 0;
  transition: opacity var(--transition-fast);
  border-radius: inherit;
}

.ibtn:hover::before {
  opacity: 0.1;
}

.ibtn:active {
  transform: scale(0.95);
}

.ibtn-accent {
  background: var(--gradient-primary);
  color: #fff;
  border-radius: var(--r-lg);
  padding: 8px;
  box-shadow: var(--glow-shadow);
  transition: all var(--transition-fast);
}

.ibtn-accent:hover {
  box-shadow: 0 0 25px rgba(99,102,241,0.4);
  transform: translateY(-1px);
}

.ibtn-accent:active {
  transform: translateY(0) scale(0.95);
}

/* ── Enhanced Filter Strip ── */
.filter-strip{
  display:flex;
  gap:8px;
  padding:16px 20px;
  overflow-x:auto;
  scroll-snap-type:x mandatory;
  -webkit-overflow-scrolling:touch;
  scrollbar-width:none;
  flex-shrink:0;
}

.filter-strip::-webkit-scrollbar{display:none}

.fpill{
  flex-shrink:0;
  padding:10px 16px;
  border-radius:var(--r-pill);
  border:1px solid var(--g-border);
  background:var(--gradient-surface);
  color:var(--t2);
  font-family:var(--font);
  font-size:13px;
  font-weight:500;
  cursor:pointer;
  white-space:nowrap;
  transition:all var(--transition-fast);
  position: relative;
  overflow: hidden;
}

.fpill::before {
  content: '';
  position: absolute;
  inset: 0;
  background: var(--gradient-accent);
  opacity: 0;
  transition: opacity var(--transition-fast);
}

.fpill:hover {
  transform: translateY(-1px);
  box-shadow: var(--muted-shadow);
  border-color: var(--accent);
}

.fpill:hover::before {
  opacity: 0.1;
}

.fpill.active{
  background: var(--gradient-primary);
  border-color: var(--accent);
  color: #fff;
  box-shadow: var(--glow-shadow);
  transform: translateY(-1px);
}

.fpill.active::before {
  opacity: 0;
}

/* ── Enhanced Book Grid ── */
.book-grid{
  flex:1;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
  padding:20px 16px 32px;
  display:flex;
  flex-direction:column;
  gap:var(--card-gap);
  align-items:stretch;
}

/* ── Enhanced Book Card ── */
.bcard{
  display:flex;
  flex-direction:row;
  align-items:center;
  gap:16px;
  cursor:pointer;
  -webkit-tap-highlight-color:transparent;
  transition:all var(--transition-smooth);
  background: var(--gradient-card);
  border-radius:var(--card-radius);
  padding:16px;
  border:1px solid var(--g-border);
  box-shadow:var(--muted-shadow);
  position: relative;
  overflow: hidden;
}

.bcard:hover {
  transform: translateY(-2px);
  box-shadow: var(--elev-shadow);
  border-color: var(--accent);
}

.bcard:active {
  transform: translateY(0) scale(0.98);
  box-shadow: 0 0 20px rgba(99,102,241,0.15);
}

.bcover-wrap{
  width:clamp(80px,20vw,140px);
  aspect-ratio:3/4;
  border-radius:var(--r-lg);
  overflow:hidden;
  display:flex;
  align-items:center;
  justify-content:center;
  background:var(--g-surface);
  border:1px solid var(--g-border);
  box-shadow:0 8px 32px rgba(0,0,0,0.25);
  position:relative;
  flex-shrink:0;
  transition: all var(--transition-fast);
}

.bcard:hover .bcover-wrap {
  transform: scale(1.05);
  box-shadow: 0 12px 40px rgba(0,0,0,0.3);
}
.bcover-img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
  transition: transform var(--transition-smooth);
}

.bcard:hover .bcover-img {
  transform: scale(1.1);
}

.bcover-ph{
  width:100%;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  gap:8px;
  color:var(--t3);
  font-size:14px;
  background: var(--gradient-surface);
}

.bfmt-badge{
  position:absolute;
  top:8px;
  left:8px;
  padding:4px 10px;
  border-radius:var(--r-pill);
  font-size:10px;
  font-weight:700;
  letter-spacing:.04em;
  background:var(--gradient-primary);
  color:#fff;
  box-shadow:0 2px 12px rgba(99,102,241,0.4);
  border:none;
  backdrop-filter: blur(8px);
  z-index: 2;
}

/* Enhanced format badges with semantic colors */
.fmt-epub{background:linear-gradient(135deg, #6366f1, #4f46e5)}
.fmt-pdf{background:linear-gradient(135deg, #ef4444, #dc2626)}
.fmt-mp3{background:linear-gradient(135deg, #10b981, #059669)}
.fmt-m4b{background:linear-gradient(135deg, #f59e0b, #d97706)}
.fmt-flac{background:linear-gradient(135deg, #a78bfa, #8b5cf6)}
.fmt-ogg{background:linear-gradient(135deg, #06b6d4, #0891b2)}

/* Enhanced card text styling */
.bmeta{
  display:flex;
  flex-direction:column;
  gap:6px;
  min-width:0;
  flex: 1;
}

.btitle{
  font-size:17px;
  font-weight:700;
  color:var(--t1);
  overflow:hidden;
  text-overflow:ellipsis;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  line-height:1.3;
  letter-spacing: -0.02em;
}

.bauthor{
  font-size:14px;
  color:var(--t2);
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  font-weight:500;
}

/* Enhanced card actions */
.card-actions{
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap:8px;
  margin-left:auto;
}

.card-play{
  width:48px;
  height:48px;
  border-radius:var(--r-pill);
  border:2px solid var(--accent);
  background:var(--gradient-primary);
  color:#fff;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  box-shadow:0 2px 12px rgba(99,102,241,0.4);
  transition:all var(--transition-fast);
  cursor: pointer;
}

.card-play:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 20px rgba(99,102,241,0.6);
}

.card-play:active {
  transform: scale(0.95);
}

.parts-badge{
  font-size:12px;
  padding:6px 12px;
  border-radius:var(--r-pill);
  background:var(--gradient-surface);
  color:var(--t2);
  border:1px solid var(--g-border);
  font-weight:500;
}
/* Enhanced responsive design */
@media(min-width:700px){
  .book-grid{
    display:grid;
    padding:24px 28px 32px;
    grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
    gap:var(--card-gap);
    align-content:start;
    place-items:start;
  }
  
  .bcard{
    flex-direction:column;
    padding:var(--card-padding);
    border-radius:var(--card-radius);
    box-shadow:var(--muted-shadow);
  }
  
  .bcard:hover {
    transform: translateY(-4px);
  }
  
  .bcover-wrap{
    width:100%;
    aspect-ratio:3/4;
    border-radius:var(--card-radius);
    box-shadow:0 12px 40px rgba(0,0,0,0.25);
  }
  
  .bcover-ph{font-size:15px}
  .bmeta{margin-top:12px}
  .card-actions{
    flex-direction:row;
    align-items:center;
    margin-left:0;
    margin-top:12px;
  }
  
  .btitle{font-size:18px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .bauthor{font-size:15px;white-space:nowrap}
}

/* ── Empty state ── */
.empty{grid-column:1/-1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:10px;padding:60px 32px;text-align:center;color:var(--t2)}
.empty-icon{width:80px;height:80px;border-radius:50%;background:rgba(255,255,255,.04);
  display:flex;align-items:center;justify-content:center;margin-bottom:8px}
.empty h3{font-size:20px;font-weight:600;color:var(--t1);letter-spacing:-.3px}
.empty p{font-size:14px;line-height:1.6}
.empty strong{color:var(--t1)}

/* ── Enhanced Buttons ── */
.gbtn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:14px 24px;
  border-radius:var(--r-lg);
  border:1px solid var(--g-border);
  background: var(--gradient-surface);
  backdrop-filter:var(--blur-s);
  -webkit-backdrop-filter:var(--blur-s);
  color:var(--t1);
  font-family:var(--font);
  font-size:15px;
  font-weight:600;
  cursor:pointer;
  -webkit-tap-highlight-color:transparent;
  transition:all var(--transition-fast);
  position:relative;
  overflow:hidden;
  width:100%;
}

.gbtn::before{
  content:'';
  position:absolute;
  inset:0;
  background: var(--sheen);
  pointer-events:none;
  opacity: 0;
  transition: opacity var(--transition-fast);
}

.gbtn:hover {
  transform: translateY(-1px);
  box-shadow: var(--muted-shadow);
  border-color: var(--accent);
}

.gbtn:hover::before {
  opacity: 1;
}

.gbtn:active{
  transform:translateY(0) scale(0.98);
  box-shadow:0 0 20px rgba(255,255,255,0.1);
}

.gbtn-primary{
  background: var(--gradient-primary);
  border-color: var(--accent);
  color: #fff;
  box-shadow: var(--glow-shadow);
  transition:all var(--transition-fast);
}

.gbtn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 0 25px rgba(99,102,241,0.5);
}

.gbtn-primary:active{
  transform:translateY(0) scale(0.98);
  box-shadow:0 0 20px rgba(99,102,241,0.3);
}

.mt16{margin-top:16px}

/* ── Enhanced Tab Bar ── */
.tab-bar{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  height:var(--tab-h);
  z-index:100;
  display:flex;
  align-items:center;
  justify-content:space-around;
  padding:12px 12px 0;
  padding-bottom:var(--safe-bottom);
  background: var(--gradient-surface);
  border-top:1px solid var(--g-border);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
}

.tbtn{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
  padding:8px 6px;
  background:none;
  border:none;
  color:var(--t3);
  font-size:12px;
  font-weight:600;
  cursor:pointer;
  transition:all var(--transition-fast);
  border-radius: var(--r-lg);
  position: relative;
}

.tbtn::before {
  content: '';
  position: absolute;
  inset: 4px;
  background: var(--gradient-accent);
  border-radius: var(--r-md);
  opacity: 0;
  transition: opacity var(--transition-fast);
}

.tbtn:hover {
  color: var(--t2);
  transform: translateY(-1px);
}

.tbtn:hover::before {
  opacity: 0.1;
}

.tab-icon-wrap{
  width:44px;
  height:44px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:var(--r-lg);
  transition:all var(--transition-fast);
  font-size:22px;
  position: relative;
  z-index: 1;
}

.tbtn.active{
  color:var(--accent);
  transform: translateY(-2px);
}

.tbtn.active .tab-icon-wrap{
  background: var(--gradient-primary);
  color: #fff;
  box-shadow: var(--glow-shadow);
  transform: scale(1.1);
}

.tbtn.active::before {
  opacity: 0.2;
}

/* ── Backdrop ── */
.backdrop{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.50);opacity:0;pointer-events:none;transition:opacity .3s}
.backdrop.vis{opacity:1;pointer-events:auto}

/* ── Enhanced Bottom Sheet ── */
.bsheet{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  z-index:201;
  background: var(--gradient-surface);
  border-top:1px solid var(--g-border);
  border-radius:var(--r-xl) var(--r-xl) 0 0;
  padding:16px 20px calc(20px + var(--safe-bottom));
  transform:translateY(110%);
  transition:transform var(--transition-smooth);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
}

.bsheet.open{
  transform:translateY(0);
}

.sh-handle{
  width:40px;
  height:4px;
  border-radius:var(--r-pill);
  background:var(--g-border);
  margin:12px auto 16px;
  transition: background var(--transition-fast);
}

.sh-handle:hover {
  background: var(--t3);
}

.sh-title{
  font-size:22px;
  font-weight:700;
  letter-spacing:-0.4px;
  margin-bottom:24px;
  color: var(--t1);
}

.src-opts{
  display:flex;
  flex-direction:column;
  gap:12px;
  margin-bottom:20px;
}

.src-opt{
  display:flex;
  align-items:center;
  gap:16px;
  padding:16px;
  border-radius:var(--r-lg);
  border:1px solid var(--g-border);
  background: var(--gradient-card);
  cursor:pointer;
  transition:all var(--transition-fast);
  min-height:56px;
  position: relative;
  overflow: hidden;
}

.src-opt::before {
  content: '';
  position: absolute;
  inset: 0;
  background: var(--gradient-accent);
  opacity: 0;
  transition: opacity var(--transition-fast);
}

.src-opt:hover {
  transform: translateY(-2px);
  box-shadow: var(--muted-shadow);
  border-color: var(--accent);
}

.src-opt:hover::before {
  opacity: 0.1;
}

.src-opt:active{
  transform:translateY(0) scale(0.98);
}

.src-icon{
  width:48px;
  height:48px;
  border-radius:var(--r-lg);
  display:flex;
  align-items:center;
  justify-content:center;
  flex-shrink:0;
  background: var(--gradient-surface);
  border: 1px solid var(--g-border);
  font-size: 20px;
  color: var(--accent);
}

.src-info{
  flex:1;
  display:flex;
  flex-direction:column;
  gap:4px;
  text-align:left;
  position: relative;
  z-index: 1;
}

.src-name{
  font-size:16px;
  font-weight:600;
  color:var(--t1);
}

.src-sub{
  font-size:13px;
  color:var(--t2);
  font-weight: 500;
}

/* ── Enhanced Search Components ── */
.search-container{
  flex:1;
  display:flex;
  flex-direction:column;
  overflow:hidden;
  padding:16px 20px 0;
  gap:16px;
}

.sinput-wrap{
  display:flex;
  align-items:center;
  gap:12px;
  padding:16px 20px;
  border-radius:var(--r-xl);
  background: var(--gradient-surface);
  border: 1px solid var(--g-border);
  color:var(--t2);
  transition: all var(--transition-fast);
  box-shadow: var(--muted-shadow);
}

.sinput-wrap:focus-within {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(99,102,241,0.1), var(--muted-shadow);
}

.sinput{
  flex:1;
  background:none;
  border:none;
  color:var(--t1);
  font-family:var(--font);
  font-size:16px;
  font-weight:500;
  outline:none;
  -webkit-appearance:none;
}

.sinput::placeholder{
  color:var(--t4);
  font-weight:400;
}

.sclear{
  background:none;
  border:none;
  color:var(--t3);
  cursor:pointer;
  padding:6px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius: var(--r-md);
  transition: all var(--transition-fast);
}

.sclear:hover {
  color: var(--t2);
  background: var(--g-bg-h);
}

.sclear.hidden{display:none}

.src-chips{
  display:flex;
  gap:8px;
  overflow-x:auto;
  scrollbar-width:none;
  flex-shrink:0;
  padding: 4px 0;
}

.src-chips::-webkit-scrollbar{display:none}

.schip{
  flex-shrink:0;
  padding:8px 16px;
  border-radius:var(--r-pill);
  border:1px solid var(--g-border);
  background: var(--gradient-card);
  color:var(--t3);
  font-family:var(--font);
  font-size:12px;
  font-weight:600;
  cursor:pointer;
  transition:all var(--transition-fast);
  white-space:nowrap;
  position: relative;
  overflow: hidden;
}

.schip::before {
  content: '';
  position: absolute;
  inset: 0;
  background: var(--gradient-accent);
  opacity: 0;
  transition: opacity var(--transition-fast);
}

.schip:hover {
  transform: translateY(-1px);
  border-color: var(--accent);
  color: var(--t2);
}

.schip:hover::before {
  opacity: 0.1;
}

.schip.active{
  background: var(--gradient-primary);
  border-color: var(--accent);
  color: #fff;
  box-shadow: var(--glow-shadow);
  transform: translateY(-1px);
}

.schip.active::before {
  opacity: 0;
}
.sresults{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;display:flex;flex-direction:column;gap:10px}
.sph{flex:1;display:flex;align-items:center;justify-content:center;text-align:center;
  color:var(--t3);font-size:14px;line-height:1.6;padding:60px 0}

/* ── Settings tab ── */
.settings-scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:16px;
  display:flex;flex-direction:column;gap:20px;padding-bottom:32px}
.sgroup{border-radius:var(--r-xl);overflow:hidden;display:flex;flex-direction:column}
.slabel{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;
  color:var(--t3);padding:14px 16px 8px}
.srow{display:flex;align-items:center;justify-content:space-between;padding:13px 16px;
  min-height:var(--touch);border-top:1px solid var(--g-border);cursor:pointer;
  -webkit-tap-highlight-color:transparent;background:transparent;border-left:none;
  border-right:none;border-bottom:none;font-family:var(--font)}
.srow:first-of-type{border-top:none}
.srow-label{font-size:15px;color:var(--t1)}
.srow-val{font-size:14px;color:var(--t2)}
.srow:active{background:rgba(255,255,255,.04)}
.sinp{margin:0 12px 12px;border-radius:var(--r-md);padding:11px 14px;font-size:14px;
  width:calc(100% - 24px);background:rgba(255,255,255,.06);border:1px solid var(--g-border);
  color:var(--t1);font-family:var(--font);outline:none;-webkit-appearance:none}
.sinp:focus{background:rgba(96,165,250,.08);border-color:rgba(96,165,250,.45);
  box-shadow:0 0 0 3px rgba(96,165,250,.12),0 0 12px rgba(96,165,250,.10)}
.shint{font-size:12px;color:var(--t3);padding:0 16px 14px;line-height:1.5}
.toggle{width:48px;height:28px;border-radius:14px;background:rgba(255,255,255,.15);
  position:relative;transition:background .25s,box-shadow .25s;flex-shrink:0}
.toggle.on{background:#34D399;box-shadow:0 0 14px rgba(52,211,153,.40),0 0 4px rgba(52,211,153,.25) inset}
.tog-knob{position:absolute;top:3px;left:3px;width:22px;height:22px;border-radius:50%;
  background:white;box-shadow:0 2px 6px rgba(0,0,0,.3),0 0 2px rgba(255,255,255,.5);
  transition:transform .25s cubic-bezier(.34,1.2,.64,1),box-shadow .25s}
.toggle.on .tog-knob{transform:translateX(20px);box-shadow:0 2px 8px rgba(0,0,0,.25),0 0 6px rgba(52,211,153,.3)}
.danger{color:#F87171}

/* ── Confirm modal ── */
.confirm-backdrop{position:fixed;inset:0;z-index:999;background:rgba(0,0,0,.55);
  backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);display:none;
  opacity:0;transition:opacity .25s}
.confirm-backdrop.show{display:block;opacity:1}
.confirm-modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%) scale(.95);
  z-index:1000;width:min(92%,380px);background:rgba(18,18,24,.92);
  backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);
  border:1px solid var(--g-border);padding:24px;border-radius:var(--r-xl);
  display:none;box-shadow:0 16px 48px rgba(0,0,0,.6),0 0 0 1px rgba(255,255,255,.05) inset;
  opacity:0;transition:opacity .25s,transform .25s cubic-bezier(.34,1.1,.64,1)}
.confirm-modal.show{display:block;opacity:1;transform:translate(-50%,-50%) scale(1)}
.confirm-modal h3{font-size:17px;font-weight:700;margin-bottom:8px;letter-spacing:-.3px}
.confirm-modal p{color:var(--t2);font-size:14px;line-height:1.5;margin-bottom:20px}
.confirm-actions{display:flex;gap:10px}
.confirm-actions .gbtn{flex:1;padding:11px 16px;font-size:14px;font-weight:600}
.confirm-actions .gbtn-danger{background:rgba(248,113,113,.18);border-color:rgba(248,113,113,.35);color:#FCA5A5}
.confirm-actions .gbtn-danger:active{background:rgba(248,113,113,.30);box-shadow:0 0 16px rgba(248,113,113,.20)}

/* ── Editor full screen ── */
.editor-scr{position:fixed;inset:0;z-index:300;display:flex;flex-direction:column;
  transform:translateY(100%);transition:transform var(--transition-slide);background:var(--g-bg);
  overflow-y:auto;-webkit-overflow-scrolling:touch;contain:layout style paint;}
.editor-scr.open{transform:translateY(0)}

/* Mobile meta panel (bottom sheet) */
#metaPanel{display:none;transition:transform .36s cubic-bezier(.2,.9,.2,1),opacity .25s;z-index:450}
.editor-scr.meta-open #metaPanel{position:fixed;left:12px;right:12px;bottom:calc(12px + var(--safe-bottom));margin:0;border-radius:16px;padding:12px 14px;display:block;max-height:64vh;overflow:auto;box-shadow:var(--elev-shadow);background:var(--gradient-surface);border:1px solid var(--g-border)}
.meta-handle{width:36px;height:4px;border-radius:4px;background:var(--g-border);margin:6px auto}
.editor-scr.meta-open{overflow:hidden}
.editor-scr.meta-open #eScroll{padding-bottom:calc(100px + var(--safe-bottom))}

/* ── Hero ── */
/* Detail panel redesign */
.hero{position:relative;height:65vh;min-height:380px;max-height:500px;flex-shrink:0;overflow:visible;background:linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #1e1b4b 100%);border-radius:var(--card-radius);box-shadow:0 20px 60px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.1);}
.hero-bg{position:absolute;inset:-40px;background-size:cover;background-position:center;
  filter:blur(60px) saturate(180%);opacity:.7;transform:scale(1.13);}
.hero-cover{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);height:88%;
  width:auto;max-width:60%;object-fit:contain;border-radius:var(--card-radius);
  box-shadow:var(--elev-shadow);z-index:2;
  border:1px solid var(--g-border);}
.hero-cover-ph{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:2;
  display:flex;flex-direction:column;align-items:center;gap:12px;color:var(--t3);font-size:18px;}

/* Hero back button (flat, non-overlapping) */
.hero .enav-back{position:absolute;top:var(--safe-top);left:12px;padding:10px 16px;border-radius:var(--r-lg);border:none;background:linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05));color:#ffffff;box-shadow:0 8px 24px rgba(0,0,0,0.3);z-index:30;min-height:var(--touch);display:flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,0.2);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);}
.hero .enav-back:hover{transform:translateY(-1px);box-shadow:0 12px 32px rgba(99,102,241,0.3);border-color:rgba(99,102,241,0.4);background:linear-gradient(135deg, rgba(99,102,241,0.2), rgba(139,92,246,0.1));}
.hero .enav-back svg{stroke:currentColor}
/* Cover frame used in hero and meta panel */
.cover-frame{width:clamp(120px,32vw,220px);aspect-ratio:180/260;border-radius:var(--r-xl);overflow:hidden;background:linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.02));border:2px solid rgba(255,255,255,0.15);display:flex;align-items:center;justify-content:center;position:relative;box-shadow:0 16px 40px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1);transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);}
.cover-frame:hover{transform:scale(1.02);box-shadow:0 20px 50px rgba(99,102,241,0.3), 0 0 30px rgba(99,102,241,0.2);border-color:rgba(99,102,241,0.4);}
.cover-frame .cover-img{width:100%;height:100%;object-fit:cover;display:block}
.cover-frame .cover-ph{display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--t3);font-size:14px;width:100%;height:100%}
.cover-frame .cover-zoom{position:absolute;right:8px;bottom:8px;width:44px;height:44px;border-radius:var(--r-lg);background:linear-gradient(135deg, rgba(99,102,241,0.8), rgba(139,92,246,0.8));color:#ffffff;display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.2);box-shadow:0 8px 20px rgba(0,0,0,0.3);transition:all var(--transition-fast);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);}
.cover-frame .cover-zoom:hover{transform:scale(1.1);box-shadow:0 12px 28px rgba(99,102,241,0.5);background:linear-gradient(135deg, rgba(99,102,241,0.9), rgba(139,92,246,0.9));}
.cover-frame.mp{width:clamp(96px,22vw,160px);aspect-ratio:120/180}

@media(min-width:1000px){
  .cover-frame{width:220px;height:320px;border-radius:18px}
  .cover-frame.mp{width:clamp(140px,18vw,180px);aspect-ratio:180/260}
}

/* Global image rules */
img, .cover-img, .bcover-img {max-width:100%;height:auto;display:block}
.hero-overlay{position:absolute;inset:0;
  background:radial-gradient(ellipse at center 30%,transparent 40%,rgba(30,27,75,.4) 100%),
  linear-gradient(to bottom,rgba(30,27,75,.5) 0%,transparent 30%,transparent 45%,rgba(30,27,75,.95) 100%);z-index:3;}

/* Hero content should respect device safe areas and scale on small iPhones */
.hero .hero-content{position:relative;z-index:4;display:flex;align-items:center;gap:clamp(12px,4vw,32px);
  padding-top:calc(18px + env(safe-area-inset-top,6px));
  padding-left:calc(16px + env(safe-area-inset-left,12px));
  padding-right:calc(16px + env(safe-area-inset-right,12px));
  padding-bottom:16px}

/* Ensure .enav uses safe horizontal insets */
.enav{left:calc(12px + env(safe-area-inset-left,0));right:calc(12px + env(safe-area-inset-right,0));}

/* Tab bar and full-screen areas must account for bottom inset */
.tab-bar{padding-bottom:calc(var(--safe-bottom));height:var(--tab-h)}
.editor-scr, .bsheet{padding-bottom:calc(var(--safe-bottom));}

/* Small device adjustments (iPhone SE and narrow devices) */
@media (max-width:360px){
  .hero{min-height:40vh}
  .hero-title{font-size:clamp(18px,6vw,26px)}
  .hero-author{font-size:13px}
  .cover-frame{width:clamp(88px,26vw,140px)}
  .enav-back{padding:6px 8px;font-size:15px}
  
  /* Enhanced mobile spacing */
  .book-grid{padding:16px 12px 24px;gap:12px}
  .bcard{padding:12px;gap:12px}
  .search-container{padding:12px 16px 0}
  .sinput-wrap{padding:12px 16px}
  
  /* Enhanced editor mobile styling */
  .editor-scr .hero{min-height:35vh}
  .editor-scr .hero-content{gap:16px}
  .editor-scr .cover-frame{width:clamp(80px,24vw,120px)}
  .editor-scr .hero-title{font-size:clamp(16px,5vw,22px)}
  .editor-scr .hero-author{font-size:12px}
  
  /* Meta panel adjustments for small devices */
  .editor-scr.meta-open #metaPanel{max-height:60vh;bottom:calc(8px + var(--safe-bottom))}
  .editor-scr.meta-open #eScroll{padding-bottom:calc(90px + var(--safe-bottom))}
}

@media (max-width:330px){
  /* Tiny phones: reduce gaps and scale typography */
  .hero .hero-content{gap:12px}
  .hero-title{font-size:20px}
  .bcard{padding:10px;gap:10px}
  .filter-strip{padding:12px 16px}
  .tab-bar{padding:8px 8px 0}
  
  /* Enhanced editor for tiny phones */
  .editor-scr .hero{min-height:30vh}
  .editor-scr .hero-content{gap:12px}
  .editor-scr .hero-title{font-size:18px}
  .editor-scr .hero-author{font-size:11px}
  .editor-scr .cover-frame{width:clamp(70px,20vw,100px)}
  
  /* Meta panel adjustments for tiny phones */
  .editor-scr.meta-open #metaPanel{max-height:55vh;bottom:calc(6px + var(--safe-bottom));left:8px;right:8px}
  .editor-scr.meta-open #eScroll{padding-bottom:calc(80px + var(--safe-bottom))}
}

/* Enhanced tablet and mobile breakpoints */
@media(max-width:700px){
  .finput{font-size:17px;padding:12px 16px;min-height:48px}
  .ftarea{min-height:180px;font-size:16px;padding:12px 16px}
  
  /* Optimized mobile book grid */
  .book-grid{
    padding:16px 12px 32px;
    gap:12px;
  }
  
  .bcard{
    padding:14px;
    gap:14px;
  }
  
  /* Enhanced editor for tablets */
  .editor-scr .hero{height:50vh;min-height:280px}
  .editor-scr .hero-content{gap:20px}
  .editor-scr .cover-frame{width:clamp(140px,28vw,200px)}
  .editor-scr .meta-panel{max-height:50vh}
  
  .bcover-wrap{
    width:clamp(80px,25vw,140px);
  }
  
  /* Enhanced mobile search */
  .search-container{
    padding:12px 16px 0;
    gap:12px;
  }
  
  .sinput-wrap{
    padding:14px 18px;
  }
}

/* Modern responsive breakpoints */
@media (max-width: 700px) {
  .book-grid {
    display:flex;
    flex-direction:column;
    padding:16px 12px 32px;
    gap:12px;
  }
  
  .tab-bar { 
    width:100%;
    left:0;
    padding:8px 12px 0;
  }
  
  .hero { 
    height:auto;
    min-height:160px;
    max-height:none;
    padding:16px 20px;
    display:flex;
    align-items:flex-start;
  }
  
  #metaPanel { 
    display:none!important; 
  }
  
  .hero-cover,.hero-cover-ph{
    width:120px;
    height:170px
  }
  
  .hero-title{font-size:18px}
  .hero-author{font-size:13px}
  
  /* Enhanced mobile components */
  .filter-strip{
    padding:12px 20px;
  }
  
  .fpill{
    padding:8px 14px;
    font-size:12px;
  }
  
  .settings-scroll{
    padding:12px 16px 32px;
  }
}

/* Prevent horizontal overflow */
html,body{
  overflow-x:hidden;
}

@media (max-width: 420px){
  .hero{
    padding-top:calc(var(--safe-top) + 8px);
    padding-left:16px;
    padding-right:16px;
  }
  
  .hero .hero-content{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:12px;
    padding:8px 0
  }
  
  .hero .cover-frame{
    width:clamp(88px,24vw,140px);
    margin-bottom:8px
  }
  
  .hero .hero-fmt,.hero-title,.hero-author{
    text-align:center
  }
  
  /* Hide older absolute cover if present */
  .hero-cover{display:none!important}
  
  /* Enhanced mobile tab bar */
  .tab-bar{
    padding:6px 8px 0;
  }
  
  .tbtn{
    padding:6px 4px;
  }
  
  .tab-icon-wrap{
    width:40px;
    height:40px;
    font-size:20px;
  }
}

/* Enhanced hero typography and format styling */
.hero-fmt{
  font-size:14px;
  font-weight:700;
  color:#fff;
  background:linear-gradient(135deg, #6366f1, #8b5cf6);
  padding:6px 16px;
  border-radius:20px;
  display:inline-block;
  margin-bottom:12px;
  text-transform:uppercase;
  letter-spacing:0.8px;
  border:2px solid rgba(255,255,255,0.2);
  box-shadow:0 4px 16px rgba(99,102,241,0.4), 0 0 12px rgba(139,92,246,0.3);
  animation:pulse-glow 2s infinite;
}

@keyframes pulse-glow{
  0%,100%{box-shadow:0 4px 16px rgba(99,102,241,0.4), 0 0 12px rgba(139,92,246,0.3);}
  50%{box-shadow:0 4px 20px rgba(99,102,241,0.6), 0 0 20px rgba(139,92,246,0.4);}
}

.hero-title{
  font-size:clamp(24px,5vw,38px);
  font-weight:900;
  color:#ffffff;
  line-height:1.2;
  letter-spacing:-1.2px;
  margin-bottom:12px;
  text-shadow:0 4px 12px rgba(0,0,0,0.4), 0 0 8px rgba(99,102,241,0.2);
  background:linear-gradient(135deg, #ffffff 0%, #e0e7ff 50%, #c7d2fe 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
  word-wrap: break-word;
  hyphens: auto;
}

.hero-author{
  font-size:clamp(16px,3.5vw,22px);
  font-weight:600;
  color:#cbd5e1;
  line-height:1.4;
  margin-bottom:20px;
  text-shadow:0 2px 8px rgba(0,0,0,0.3);
  letter-spacing:-0.3px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  word-wrap: break-word;
}

/* Enhanced hero change cover button */
.hcbtn{
  background:linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05));
  color:#ffffff;
  border:2px solid rgba(255,255,255,0.2);
  padding:10px 20px;
  border-radius:12px;
  font-size:14px;
  font-weight:600;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:8px;
  transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow:0 8px 24px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
  backdrop-filter:blur(10px);
  -webkit-backdrop-filter:blur(10px);
  position:relative;
  overflow:hidden;
}

.hcbtn::before{
  content:'';
  position:absolute;
  top:0;
  left:-100%;
  width:100%;
  height:100%;
  background:linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition:left 0.6s;
}

.hcbtn:hover::before{
  left:100%;
}

.hcbtn:hover{
  transform:translateY(-2px) scale(1.02);
  box-shadow:0 12px 32px rgba(99,102,241,0.4), 0 0 20px rgba(99,102,241,0.2);
  border-color:rgba(99,102,241,0.6);
  background:linear-gradient(135deg, rgba(99,102,241,0.2), rgba(139,92,246,0.1));
}

.hcbtn:active{
  transform:translateY(-1px) scale(0.98);
  box-shadow:0 6px 20px rgba(99,102,241,0.3);
}

.hcbtn svg{
  width:16px;
  height:16px;
  stroke:currentColor;
  filter:drop-shadow(0 1px 2px rgba(0,0,0,0.3));
}

/* Enhanced form styling to match theme */
.finput, .ftarea {
  background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
  border: 2px solid rgba(255,255,255,0.15);
  border-radius: var(--r-lg);
  padding: 14px 18px;
  color: #ffffff;
  font-family: var(--font);
  font-size: 16px;
  font-weight: 500;
  outline: none;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  box-shadow: 0 4px 16px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.1);
}

.finput:focus, .ftarea:focus {
  border-color: rgba(99,102,241,0.6);
  background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(99,102,241,0.05));
  box-shadow: 0 0 0 3px rgba(99,102,241,0.2), 0 8px 24px rgba(99,102,241,0.3), inset 0 1px 0 rgba(255,255,255,0.2);
  transform: translateY(-1px);
}

.finput::placeholder, .ftarea::placeholder {
  color: rgba(255,255,255,0.5);
  font-weight: 400;
  opacity: 1;
}

.finput:hover, .ftarea:hover {
  border-color: rgba(255,255,255,0.25);
  background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.04));
  box-shadow: 0 6px 20px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.15);
}

.ftarea {
  min-height: 120px;
  resize: vertical;
  font-family: var(--font);
  line-height: 1.5;
}

/* Form labels styling */
.flabel {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: rgba(255,255,255,0.8);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Form groups styling */
.fgroup {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

/* Form dividers */
.fdiv {
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
  margin: 8px 0;
}

/* Form cards styling */
.fcard {
  background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: var(--r-xl);
  padding: 20px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.fcard:hover {
  border-color: rgba(99,102,241,0.3);
  box-shadow: 0 12px 40px rgba(99,102,241,0.2), 0 8px 32px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.08);
}

/* Enhanced cover art area layout */
.cover-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
  flex-shrink: 0;
  padding: 20px;
  background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
  border-radius: 24px;
  border: 1px solid rgba(255,255,255,0.1);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  position: relative;
  overflow: hidden;
}

.cover-section::before {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(circle at 50% 50%, rgba(99,102,241,0.1) 0%, transparent 70%);
  pointer-events: none;
}

.cover-actions {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  width: 100%;
  position: relative;
  z-index: 2;
}

.book-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 24px;
  padding: 20px 0;
  min-width: 0;
}

.book-meta {
  display: flex;
  flex-direction: column;
  gap: 12px;
  min-height: 120px;
  overflow: visible;
}

.book-actions {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

/* Enhanced hero content layout */
.hero .hero-content {
  position: relative;
  z-index: 4;
  display: flex;
  align-items: flex-start;
  gap: clamp(24px,6vw,48px);
  padding-top: calc(24px + env(safe-area-inset-top,6px));
  padding-left: calc(24px + env(safe-area-inset-left,12px));
  padding-right: calc(24px + env(safe-area-inset-right,12px));
  padding-bottom: 32px;
  max-width: 1400px;
  margin: 0 auto;
  overflow: visible;
}

/* Enhanced cover frame positioning */
.cover-section .cover-frame {
  position: relative;
  z-index: 3;
  transform: perspective(1000px) rotateY(-5deg);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.cover-section:hover .cover-frame {
  transform: perspective(1000px) rotateY(0deg) scale(1.02);
}

.cover-section .cover-zoom {
  opacity: 0;
  transform: scale(0.8);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.cover-section:hover .cover-zoom {
  opacity: 1;
  transform: scale(1);
}

/* Enhanced book info positioning */
.book-info {
  animation: slideInRight 0.6s cubic-bezier(0.4, 0, 0.2, 1) both;
}

@keyframes slideInRight {
  from {
    opacity: 0;
    transform: translateX(30px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

/* Responsive improvements */
@media (max-width: 768px) {
  .hero .hero-content {
    flex-direction: column;
    gap: 32px;
    padding: 20px;
    text-align: center;
  }
  
  .cover-section {
    padding: 16px;
    gap: 16px;
  }
  
  .book-info {
    width: 100%;
    text-align: center;
  }
  
  .book-actions {
    justify-content: center;
  }
  
  .cover-section .cover-frame {
    transform: none;
  }
  
  .cover-section:hover .cover-frame {
    transform: scale(1.02);
  }
}

@media (max-width: 480px) {
  .cover-section {
    padding: 12px;
    gap: 12px;
  }
  
  .book-info {
    gap: 16px;
  }
  
  .book-actions {
    gap: 8px;
  }
}

@media (max-width: 480px) {
  .scr-title { 
    font-size:26px; 
    letter-spacing: -0.6px;
  }
  
  /* Enhanced mobile inputs */
  .sinput{
    font-size:15px;
  }
  
  .btitle{
    font-size:16px;
  }
  
  .bauthor{
    font-size:13px;
  }
}
.cg0{background:linear-gradient(135deg,#1e3a8a,#6366f1)}
.cg1{background:linear-gradient(135deg,#064e3b,#0f766e)}
.cg2{background:linear-gradient(135deg,#7c2d12,#c2410c)}
.cg3{background:linear-gradient(135deg,#4c1d95,#7c3aed)}
.cg4{background:linear-gradient(135deg,#0c4a6e,#0369a1)}
.cg5{background:linear-gradient(135deg,#831843,#be185d)}
</style>
<!-- New clean theme overrides -->
<style>
/* Clean theme (flat, light) */
.clean{ --ct-bg:#f6f7fb; --ct-surface:#ffffff; --ct-muted:#6b7280; --ct-accent:#2563eb; --ct-text:#0f1724; }
.clean html, .clean body { background:var(--ct-bg) !important; color:var(--ct-text) !important }
.clean .gbar, .clean .glass { background:var(--ct-surface) !important; border-color:rgba(15,23,36,0.06) !important; box-shadow:0 6px 18px rgba(15,23,36,0.06) !important }
.clean .bg, .clean .orb, .clean .noise { display:none !important }
.clean .scr-hdr{background:transparent;border-bottom:1px solid rgba(15,23,36,0.04);}
.clean .scr-title{color:var(--ct-text)}
.clean .ibtn, .clean .gbtn{background:transparent;border:1px solid rgba(15,23,36,0.06);color:var(--ct-text)}
.clean .ibtn-accent, .clean .gbtn-primary{background:var(--ct-accent);color:#fff;border:none}
.clean .bcard{background:var(--ct-surface);border:1px solid rgba(15,23,36,0.04);box-shadow:0 6px 18px rgba(15,23,36,0.04);border-radius:10px}
.clean .btitle{color:var(--ct-text)}
.clean .bauthor{color:var(--ct-muted)}
.clean .hero{background:transparent;box-shadow:none;border-radius:0;padding:12px 16px}
.clean .hero .cover-frame{box-shadow:0 6px 18px rgba(15,23,36,0.06);border:1px solid rgba(15,23,36,0.04)}
.clean .hero-title{color:var(--ct-text)}
.clean .hero-author{color:var(--ct-muted)}
.clean .tab-bar{background:transparent;border-top:1px solid rgba(15,23,36,0.04);box-shadow:none}
.clean .tbtn{color:var(--ct-muted)}
.clean .tbtn.active{color:var(--ct-accent)}
.clean .finput{background:transparent;border:1px solid rgba(15,23,36,0.06);color:var(--ct-text)}
.clean .ftarea{background:transparent;border:1px solid rgba(15,23,36,0.06)}
.clean .meta-top .ibtn{border:1px solid rgba(15,23,36,0.06);background:transparent}
.clean .cover-zoom{background:rgba(15,23,36,0.04)}
.clean .backdrop{background:rgba(15,23,36,0.45)}
</style>
/* Mobile-only enforcement overrides */
<style>
  /* Force the app to behave like a native mobile app */
  html,body{height:100%;width:100%;}
  /* Editor overlay is full screen and scrolls normally */
  .editor-scr{position:fixed;inset:0;z-index:300;display:block;overflow-y:auto;background:var(--ct-bg, var(--g-bg));}
  .editor-scr.open{transform:none}
  /* Meta panel acts as a bottom sheet when toggled */
  #metaPanel{display:none;position:fixed;left:10px;right:10px;bottom:10px;margin:0;border-radius:12px;padding:12px 14px;max-height:70vh;overflow:auto;box-shadow:0 18px 48px rgba(0,0,0,0.28);z-index:450}
  .editor-scr.meta-open #metaPanel{display:block}
  /* Ensure the library is a single column list */
  .book-grid{display:flex;flex-direction:column;padding:12px;gap:12px}
  .bcard{width:100%}
  /* Bigger touch targets */
  .ibtn, .gbtn, .tbtn{min-height:48px;padding:10px}
  .tab-bar{left:0;right:0;width:100%;border-radius:0;height:var(--tab-h);padding-bottom:env(safe-area-inset-bottom,12px)}
  /* Constrain width on large screens but keep mobile layout */
  @media(min-width:700px){
    body{max-width:460px;margin:0 auto}
  }
</style>
<style>
/* Standalone vs browser mode helper classes toggled by JS */
html.standalone{ --safe-top: calc(env(safe-area-inset-top, 18px) + 12px); --safe-bottom: calc(env(safe-area-inset-bottom, 12px) + 12px); }
html.browser{ --safe-top: calc(env(safe-area-inset-top, 10px) + 6px); --safe-bottom: calc(env(safe-area-inset-bottom, 6px) + 6px); }
html.standalone .enav{ padding-top: var(--safe-top); }
html.browser .enav{ padding-top: calc(var(--safe-top) - 8px); }
</style>
<!-- iOS-specific refreshed layout overrides -->
<style>
/* Applied when JS detects an iOS device and adds `ios` class to <html> */
html.ios{
  --font: -apple-system, 'SF Pro Text', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  --base-font-size: clamp(15px, 1.8vw + 12px, 18px);
}

html.ios body{ -webkit-font-smoothing:antialiased; -webkit-text-size-adjust:100%; }

/* Show a visible safe-area top spacer in standalone mode for iOS home-screen apps */
html.ios.standalone .sbpad{display:block;height:var(--safe-top);}

/* Enforce larger touch targets and spacing on iOS */
html.ios .ibtn, html.ios .gbtn, html.ios .tbtn{min-height:56px;padding:12px}
html.ios .tab-bar{height:calc(60px + var(--safe-bottom));padding-bottom:var(--safe-bottom);}

/* Hero: stack on narrow iPhones, avoid absolute cover overlap */
html.ios .hero{border-radius:14px;padding-left:16px;padding-right:16px;padding-top:calc(var(--safe-top) + 10px);}
html.ios .hero .hero-content{display:flex;flex-direction:column;align-items:center;gap:14px;padding:8px 0}
html.ios .hero .cover-frame{width:clamp(96px,26vw,160px);aspect-ratio:120/160;margin-bottom:6px}
html.ios .hero-cover, html.ios .hero-cover-ph{position:static;transform:none}

/* Top navigation: pinned but respecting safe insets */
html.ios .enav{position:fixed;left:env(safe-area-inset-left,12px);right:env(safe-area-inset-right,12px);top:calc(var(--safe-top) - 8px);z-index:60}

/* Editor overlay: account for safe-top so content is not hidden */
html.ios .editor-scr{padding-top:var(--safe-top)}

/* Ensure bottom sheets and tab bar avoid the home indicator */
html.ios .bsheet, html.ios .tab-bar, html.ios .bsheet .sh-handle{padding-bottom:var(--safe-bottom)}

/* Reduce hero image shadows and avoid spilling under notch */
html.ios .hero-bg, html.ios .hero-cover{box-shadow:none}

/* Prevent accidental pull-to-refresh visual overflow */
html.ios, html.ios body{overscroll-behavior-y:contain}
</style>
</head>
<body>

<!-- Ambient bg -->
<div class="bg" aria-hidden="true">
  <div class="orb o1"></div><div class="orb o2"></div><div class="orb o3"></div><div class="orb o4"></div>
  <div class="noise"></div>
</div>
<div class="sbpad"></div>

<!-- Pull-to-refresh indicator -->
<div id="ptr" class="ptr" aria-hidden="true">
  <div class="ptr-inner">
    <div class="ptr-icon" id="ptrIcon">⟲</div>
    <div class="ptr-text" id="ptrText">Pull to refresh</div>
  </div>
</div>

<style>
/* Pull-to-refresh visuals */
.ptr{position:fixed;top:0;left:0;right:0;height:60px;display:flex;align-items:flex-end;justify-content:center;transform:translateY(-60px);transition:transform .18s ease,opacity .18s;z-index:9999;pointer-events:none}
.ptr .ptr-inner{display:flex;align-items:center;gap:10px;padding-bottom:8px;background:transparent;color:var(--t2);font-size:14px}
.ptr .ptr-icon{width:28px;height:28px;border-radius:8px;background:rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;font-size:16px}
.ptr.pull{transform:translateY(6px);pointer-events:none}
.ptr.release{transform:translateY(48px);pointer-events:none}
.ptr.refreshing .ptr-icon{animation:ptr-rotate .9s linear infinite}
@keyframes ptr-rotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
</style>

<!-- ════════ LIBRARY ════════ -->
<div class="tab-screen active" id="scrLibrary">
  <header class="scr-hdr gbar">
    <h1 class="scr-title">Library</h1>
    <div class="hdr-actions">
      <button class="ibtn" id="btnSearch" aria-label="Search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      </button>
      <button class="ibtn ibtn-accent" id="btnAdd" aria-label="Add">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      </button>
    </div>
  </header>
  <div class="filter-strip" id="filterStrip">
    <button class="fpill active" data-fmt="all">All</button>
    <button class="fpill" data-fmt="epub">EPUB</button>
    <button class="fpill" data-fmt="pdf">PDF</button>
    <button class="fpill" data-fmt="mp3">MP3</button>
    <button class="fpill" data-fmt="m4b">M4B</button>
    <button class="fpill" data-fmt="flac">FLAC</button>
    <button class="fpill" data-fmt="ogg">OGG</button>
  </div>
  <div class="book-grid" id="bookGrid">
    <div class="empty" id="emptyState">
      <div class="empty-icon">
        <svg width="48" height="48" viewBox="0 0 48 48" fill="none"><circle cx="24" cy="24" r="20" fill="url(#eg)" opacity=".12"/><path d="M24 14v14M17 21l7-7 7 7" stroke="url(#eg)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 33h24" stroke="url(#eg)" stroke-width="2.5" stroke-linecap="round"/><defs><linearGradient id="eg" x1="10" y1="12" x2="38" y2="38" gradientUnits="userSpaceOnUse"><stop stop-color="#60A5FA"/><stop offset="1" stop-color="#A78BFA"/></linearGradient></defs></svg>
      </div>
      <h3>No books yet</h3>
      <p>Tap <strong>+</strong> to add from Files,<br/>iCloud Drive, or Google Drive</p>
      <button class="gbtn gbtn-primary mt16" id="btnAddEmpty">Add Books</button>
    </div>
  </div>
</div>

<!-- ════════ SEARCH ════════ -->
<div class="tab-screen" id="scrSearch">
  <header class="scr-hdr gbar"><h1 class="scr-title">Search</h1></header>
  <div class="search-container">
    <div class="sinput-wrap glass">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input type="search" class="sinput" id="gSearch" placeholder="Search title, author, ISBN…" enterkeyhint="search"/>
      <button class="sclear hidden" id="btnSClear">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
      </button>
    </div>
    <div class="src-chips">
      <button class="schip active" data-src="Google Books">Google Books</button>
      <button class="schip active" data-src="Open Library">Open Library</button>
      <button class="schip active" data-src="iTunes / Audible">iTunes</button>
      <button class="schip active" data-src="MusicBrainz">MusicBrainz</button>
    </div>
    <div class="sresults" id="sResults"><div class="sph"><p>Search all sources at once<br/>and tap a result to apply it</p></div></div>
  </div>
</div>

<!-- ════════ SETTINGS ════════ -->
<div class="tab-screen" id="scrSettings">
  <header class="scr-hdr gbar"><h1 class="scr-title">Settings</h1></header>
  <div class="settings-scroll">
    <div class="sgroup glass">
      <div class="slabel">Google Drive</div>
      <div class="srow"><span class="srow-label">OAuth Client ID</span></div>
      <input type="text" class="sinp" id="settGDrive" placeholder="Paste your Google OAuth Client ID"/>
      <p class="shint">Required for Google Drive integration. Create one at console.cloud.google.com.</p>
    </div>
    <div class="sgroup glass">
      <div class="slabel">Metadata</div>
      <div class="srow" id="togAutoFetch"><span class="srow-label">Auto-fetch on import</span><div class="toggle on" id="autoFetchToggle"><div class="tog-knob"></div></div></div>
    </div>
    <div class="sgroup glass">
      <div class="slabel">Library</div>
      <button class="srow" id="btnClearLib" style="text-align:left;width:100%;cursor:pointer;background:none;border-top:1px solid var(--g-border);border-left:none;border-right:none;border-bottom:none;font-family:var(--font);display:flex;align-items:center;justify-content:space-between">
        <span class="srow-label danger">Clear All Books</span>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#F87171" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/></svg>
      </button>
    </div>
    <div class="sgroup glass">
      <div class="slabel">About</div>
      <div class="srow"><span class="srow-label">Version</span><span class="srow-val">1.0.0</span></div>
      <div class="srow"><span class="srow-label">Sources</span><span class="srow-val">4 APIs</span></div>
      <div class="srow"><span class="srow-label">Formats</span><span class="srow-val">EPUB · PDF · MP3 · M4B · FLAC · OGG</span></div>
    </div>
  </div>
</div>

<!-- ════════ TAB BAR ════════ -->
<nav class="tab-bar gbar" id="tabBar">
  <button class="tbtn active" data-tab="Library">
    <div class="tab-icon-wrap"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg></div>
    <span>Library</span>
  </button>
  <button class="tbtn" data-tab="Search">
    <div class="tab-icon-wrap"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg></div>
    <span>Search</span>
  </button>
  <button class="tbtn" data-tab="Settings">
    <div class="tab-icon-wrap"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></div>
    <span>Settings</span>
  </button>
</nav>

<!-- ════════ SOURCE PICKER SHEET ════════ -->
<div class="backdrop" id="srcBackdrop"></div>
<div class="bsheet" id="srcSheet">
  <div class="sh-handle"></div>
  <h2 class="sh-title">Add Books</h2>
  <div class="src-opts">
    <button class="src-opt" id="srcLocal">
      <div class="src-icon" style="background:linear-gradient(135deg,#3B82F6,#6366F1)"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg></div>
      <div class="src-info"><span class="src-name">Files / Local Storage</span><span class="src-sub">Browse on-device files</span></div>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity=".4"><polyline points="9 18 15 12 9 6"/></svg>
    </button>

    <button class="src-opt" id="srcLocalMulti">
      <div class="src-icon" style="background:linear-gradient(135deg,#3B82F6,#06B6D4)"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg></div>
      <div class="src-info"><span class="src-name">Files (multiple)</span><span class="src-sub">Select several files and import as one entry</span></div>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity=".4"><polyline points="9 18 15 12 9 6"/></svg>
    </button>

    <button class="src-opt" id="srcICloud">
      <div class="src-icon" style="background:linear-gradient(135deg,#06B6D4,#3B82F6)"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg></div>
      <div class="src-info"><span class="src-name">iCloud Drive</span><span class="src-sub">Open from iCloud</span></div>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity=".4"><polyline points="9 18 15 12 9 6"/></svg>
    </button>
    <button class="src-opt" id="srcGDrive">
      <div class="src-icon" style="background:linear-gradient(135deg,#F59E0B,#EF4444)"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="m12 3-9 15h18z"/><path d="m7.5 12 4.5 7.5"/><path d="m16.5 12-4.5 7.5"/></svg></div>
      <div class="src-info"><span class="src-name">Google Drive</span><span class="src-sub">Sign in and browse Drive</span></div>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity=".4"><polyline points="9 18 15 12 9 6"/></svg>
    </button>
  </div>
  <button class="gbtn" id="btnSheetCancel">Cancel</button>
</div>

<!-- ════════ EDITOR ════════ -->
<div class="editor-scr" id="editorScr">
  <div class="hero" id="eHero">
    <div class="hero-bg" id="eBg"></div>
    <div class="hero-overlay"></div>
    <div class="enav" aria-hidden="false"></div>
    <div class="hero-content">
      <div class="cover-section">
        <div class="cover-frame" id="heroCoverFrame">
          <img class="cover-img" id="eCover" src="" alt="" style="display:none"/>
          <div class="cover-ph" id="eCoverPh"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg><span style="font-size:14px;color:var(--t3);margin-top:8px">No cover</span></div>
          <button class="cover-zoom" id="btnCoverZoom" title="View cover">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.3-4.3"/></svg>
          </button>
        </div>
        <div class="cover-actions">
          <button class="hcbtn" id="btnCoverChange"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4z"/></svg>Change Cover</button>
        </div>
      </div>
      <div class="book-info">
        <div class="book-meta">
          <div class="hero-fmt" id="eFormat">EPUB</div>
          <h2 class="hero-title" id="eTitle">—</h2>
          <p class="hero-author" id="eAuthor">—</p>
        </div>
        <div class="book-actions">
          <button class="ibtn" id="btnFetch" title="Fetch"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>
          <button class="ibtn ibtn-accent" id="btnSave" title="Save"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg></button>
          <button class="ibtn" id="btnMetaToggle" title="Details"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="6" r="1.6"/><circle cx="12" cy="12" r="1.6"/><circle cx="12" cy="18" r="1.6"/></svg></button>
        </div>
      </div>
      <!-- back button moved into .enav for correct positioning -->
    </div>
  </div>

  <aside id="metaPanel" class="glass" style="display:none;">
    <div class="meta-top" style="display:flex;flex-direction:column;gap:8px">
      <div class="meta-handle"></div>
      <div style="display:flex;justify-content:flex-end"><button class="ibtn" id="btnMetaClose" title="Close" style="width:40px;height:40px;padding:0">✕</button></div>
    </div>
    <div class="fgroup" style="display:flex;flex-direction:column;align-items:center;gap:10px">
      <div id="mpCoverWrap" class="cover-frame mp" style="width:clamp(96px,22vw,160px);aspect-ratio:120/180;">
        <img id="mpCoverImg" class="cover-img" src="" alt="" style="display:none"/>
        <div id="mpCoverPh" class="cover-ph" style="font-size:12px">No cover</div>
      </div>
      <div style="text-align:center"><div id="mpTitle" style="font-weight:700;font-size:16px">—</div><div id="mpAuthor" style="font-size:13px;color:var(--t2)">—</div></div>
    </div>
    <div class="fgroup"><label class="flabel">Parts</label><div id="mpParts" style="display:flex;flex-direction:column;gap:8px"></div></div>
    <div class="fgroup"><button class="gbtn gbtn-primary" id="mpPlayAll">Play All</button><div style="height:8px"></div><button class="gbtn" id="mpFetchMeta">Fetch Metadata</button></div>
  </aside>

  <div class="escroll" id="eScroll">
    <div class="astrip glass" id="aStrip" style="display:none">
      <div class="astat"><span class="ast-val" id="aDur">—</span><span class="ast-lbl">Duration</span></div>
      <div class="adiv"></div>
      <div class="astat"><span class="ast-val" id="aBit">—</span><span class="ast-lbl">Bitrate</span></div>
      <div class="adiv"></div>
      <div class="astat"><span class="ast-val" id="aSR">—</span><span class="ast-lbl">Sample Rate</span></div>
      <div class="adiv"></div>
      <div class="astat"><span class="ast-val" id="aCh">—</span><span class="ast-lbl">Channels</span></div>
    </div>
    <div class="fcard glass">
      <div class="fgroup"><label class="flabel">Title</label><input class="finput" id="fTitle" placeholder="Book title"/></div>
      <div class="fdiv"></div>
      <div class="fgroup"><label class="flabel">Author</label><input class="finput" id="fAuthor" placeholder="Author name"/></div>
      <div class="fdiv"></div>
      <div class="fgroup"><label class="flabel">Narrator</label><input class="finput" id="fNarrator" placeholder="Narrator (audiobooks)"/></div>
    </div>
    <div class="fcard glass">
      <div class="fgroup"><label class="flabel">Series</label><input class="finput" id="fSeries" placeholder="Series name"/></div>
      <div class="fdiv"></div>
      <div class="fgroup"><label class="flabel">Year</label><input class="finput" id="fYear" type="number" placeholder="2024"/></div>
      <div class="fdiv"></div>
      <div class="fgroup"><label class="flabel">Publisher</label><input class="finput" id="fPub" placeholder="Publisher"/></div>
      <div class="fdiv"></div>
      <div class="fgroup"><label class="flabel">Genre</label><input class="finput" id="fGenre" placeholder="Genre"/></div>
    </div>
    <div class="fcard glass">
      <div class="fgroup"><label class="flabel">ISBN</label><input class="finput" id="fISBN" placeholder="ISBN-13" inputmode="numeric"/></div>
      <div class="fdiv"></div>
      <div class="fgroup"><label class="flabel">Language</label><input class="finput" id="fLang" placeholder="en"/></div>
    </div>
    <div class="fcard glass">
      <div class="fgroup"><label class="flabel">Parts</label>
        <div id="partsList" style="display:flex;flex-direction:column;gap:8px"></div>
      </div>
    </div>
    <div class="fcard glass">
      <div class="fgroup"><label class="flabel">Description</label><textarea class="finput ftarea" id="fDesc" rows="8" placeholder="Synopsis / description"></textarea></div>
    </div>
    <div class="epad"></div>
  </div>

  <!-- Results half-sheet -->
  <div class="res-back" id="rBack" style="display:none"></div>
  <div class="res-sheet glass" id="rSheet" style="display:none">
    <div class="sh-handle"></div>
    <div class="res-hdr"><span id="rSheetTitle">Results</span>
      <button class="ibtn" id="btnCloseR"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="rlist" id="rList"></div>
  </div>
</div>

<!-- Toast & loader -->
<div class="toast" id="toast"></div>
<div class="lpill glass" id="lpill" style="display:none"><div class="spin"></div><span id="lmsg">Loading…</span></div>

<!-- Cover viewer modal -->
<div id="coverViewer" class="backdrop" style="display:none;align-items:center;justify-content:center;">
  <div style="max-width:92vw;max-height:86vh;overflow:hidden;border-radius:12px;box-shadow:0 24px 64px rgba(0,0,0,.7);">
    <img id="coverViewImg" src="" alt="Cover" style="display:block;max-width:100%;max-height:86vh;object-fit:contain;"/>
  </div>
</div>

<!-- Confirm modal -->
<div class="confirm-backdrop" id="confirmBg"></div>
<div class="confirm-modal" id="confirmMod">
  <h3 id="confirmTitle">Confirm</h3>
  <p id="confirmBody"></p>
  <div class="confirm-actions">
    <button class="gbtn gbtn-danger" id="confirmOk">Yes, Delete</button>
    <button class="gbtn" id="confirmCancel">Cancel</button>
  </div>
</div>

<script>
'use strict';
// enable new clean theme by default
document.documentElement.classList.add('clean');
// Ensure a known base history state for mobile PWA navigation
try{ if(!history.state || history.state.page!=='library') history.replaceState({page:'library'}, '', location.pathname + location.search); }catch(e){}
// ── State ────────────────────────────────────────────────────────────────────
const S = {
  library: [],
  activeIdx: -1,
  activeTab: 'Library',
  filterFmt: 'all',
  settings: { gDriveId: '', autoFetch: true },
};



// ── DOM ──────────────────────────────────────────────────────────────────────
const $ = id => document.getElementById(id);
const D = {
  scrLib:$('scrLibrary'), scrSearch:$('scrSearch'), scrSettings:$('scrSettings'),
  bookGrid:$('bookGrid'), emptyState:$('emptyState'), filterStrip:$('filterStrip'),
  srcBackdrop:$('srcBackdrop'), srcSheet:$('srcSheet'),
  editorScr:$('editorScr'), eBg:$('eBg'), eCover:$('eCover'), eCoverPh:$('eCoverPh'),
  eFormat:$('eFormat'), eTitle:$('eTitle'), eAuthor:$('eAuthor'),
  aStrip:$('aStrip'), aDur:$('aDur'), aBit:$('aBit'), aSR:$('aSR'), aCh:$('aCh'),
  fTitle:$('fTitle'), fAuthor:$('fAuthor'), fNarrator:$('fNarrator'),
  partsList:$('partsList'),
  metaPanel:$('metaPanel'), mpCoverImg:$('mpCoverImg'), mpCoverPh:$('mpCoverPh'), mpTitle:$('mpTitle'), mpAuthor:$('mpAuthor'), mpParts:$('mpParts'), mpPlayAll:$('mpPlayAll'), mpFetchMeta:$('mpFetchMeta'),
  fSeries:$('fSeries'), fYear:$('fYear'), fPub:$('fPub'), fGenre:$('fGenre'),
  fISBN:$('fISBN'), fLang:$('fLang'), fDesc:$('fDesc'),
  rBack:$('rBack'), rSheet:$('rSheet'), rList:$('rList'), rSheetTitle:$('rSheetTitle'),
  gSearch:$('gSearch'), sResults:$('sResults'), btnSClear:$('btnSClear'),
  settGDrive:$('settGDrive'), eScroll:$('eScroll'),
  toast:$('toast'), lpill:$('lpill'), lmsg:$('lmsg'),
};

// ── Confirm modal ────────────────────────────────────────────────────────────
function showConfirm(title, body, btnLabel) {
  return new Promise(res => {
    const bg = $('confirmBg'), mod = $('confirmMod');
    $('confirmTitle').textContent = title || 'Confirm';
    $('confirmBody').textContent = body || '';
    if (btnLabel) $('confirmOk').textContent = btnLabel;
    bg.style.display = 'block'; mod.style.display = 'block';
    requestAnimationFrame(() => { bg.classList.add('show'); mod.classList.add('show'); });
    const cleanup = () => { bg.classList.remove('show'); mod.classList.remove('show');
      setTimeout(() => { bg.style.display='none'; mod.style.display='none'; }, 300);
      $('confirmOk').removeEventListener('click', onOk);
      $('confirmCancel').removeEventListener('click', onCancel);
      bg.removeEventListener('click', onCancel);
    };
    const onOk = () => { cleanup(); res(true); };
    const onCancel = () => { cleanup(); res(false); };
    $('confirmOk').addEventListener('click', onOk);
    $('confirmCancel').addEventListener('click', onCancel);
    bg.addEventListener('click', onCancel);
  });
}

// ── Toast ─────────────────────────────────────────────────────────────────────
let toastT;
function toast(msg, cls='', ms=3000) {
  D.toast.textContent = msg;
  D.toast.className = `toast${S.activeIdx>=0?' in-editor':''}${cls?' '+cls:''}`;
  requestAnimationFrame(()=>D.toast.classList.add('show'));
  clearTimeout(toastT);
  toastT = setTimeout(()=>D.toast.classList.remove('show'), ms);
}
function showLoad(msg='Loading…'){D.lmsg.textContent=msg;D.lpill.style.display='flex'}
function hideLoad(){D.lpill.style.display='none'}

// ── Tabs ──────────────────────────────────────────────────────────────────────
const TAB_MAP = {Library:'scrLibrary', Search:'scrSearch', Settings:'scrSettings'};
document.querySelectorAll('.tbtn').forEach(b=>{
  b.addEventListener('click',()=>{
    if(b.dataset.tab===S.activeTab) return;
    switchTab(b.dataset.tab);
  });
});
function switchTab(tab) {
  S.activeTab=tab;
  // Save active tab to localStorage
  try {
    localStorage.setItem('bmg_active_tab', tab);
  } catch(e) {
    console.warn('Failed to save active tab:', e);
  }
  document.querySelectorAll('.tab-screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.tbtn').forEach(b=>b.classList.toggle('active',b.dataset.tab===tab));
  $(TAB_MAP[tab])?.classList.add('active');
}

// Tab buttons routing
$('btnSearch').addEventListener('click',()=>switchTab('Search'));

// ── Source Picker ─────────────────────────────────────────────────────────────
function openPicker(){D.srcBackdrop.classList.add('vis');D.srcSheet.classList.add('open')}
function closePicker(){D.srcBackdrop.classList.remove('vis');D.srcSheet.classList.remove('open')}
$('btnAdd').addEventListener('click',openPicker);
$('btnAddEmpty').addEventListener('click',openPicker);
D.srcBackdrop.addEventListener('click',closePicker);
$('btnSheetCancel').addEventListener('click',closePicker);

// File input
function makeFilePicker() {
  const inp = document.createElement('input');
  inp.type='file'; inp.accept='.epub,.pdf,.mp3,.m4b,.m4a,.flac,.ogg,.opus'; inp.multiple=true;
  inp.onchange = async()=>{
    closePicker();
    const files = Array.from(inp.files||[]);
    if(!files.length) return;
    showLoad(`Importing ${files.length} file${files.length>1?'s':''}…`);
    for(const f of files){
      const fmt = f.name.split('.').pop().toLowerCase();
      const entry = {
        id: Date.now()+Math.random(), fileName:f.name, format:fmt,
        title: guessTitle(f.name), author:'', narrator:'', series:'', year:'',
        publisher:'', genre:'', isbn:'', description:'', language:'',
        coverBase64:null, coverMime:null, duration:null, bitrate:null, sampleRate:null, channels:null,
      };
      // Attempt to parse author/title from filename
      try{ const pa = parseTitleAuthor(f.name); if(pa){ if(pa.title) entry.title = pa.title; if(pa.author) entry.author = pa.author; } }catch(e){}
      // Try to read embedded metadata
      try {
        const ab = await f.arrayBuffer();
        if(fmt==='epub') { Object.assign(entry, await parseEpub(ab, f.name)); }
      } catch(e){}
      S.library.unshift(entry);
      if(S.settings.autoFetch && entry.title){
        try{
          const q = `${entry.title}${entry.author? ' '+entry.author : ''}`;
          const results = await fetchAll(q);
          await applyBestMetadata(S.library[0], results);
        }catch(e){}
      }
    }
    hideLoad();
    saveLibrary();
    renderLibrary();
    toast(`Added ${files.length} book${files.length>1?'s':''}`, 'success');
  };
  return inp;
}

$('srcLocal').addEventListener('click',()=>makeFilePicker().click());
$('srcICloud').addEventListener('click',()=>makeFilePicker().click());
$('srcLocalMulti').addEventListener('click',()=>makeGroupedFilePicker().click());
$('srcGDrive').addEventListener('click',()=>{
  closePicker();
  if(!S.settings.gDriveId){ toast('Add your Google Client ID in Settings first','',5000); setTimeout(()=>switchTab('Settings'),800); return; }
  toast('Google Drive requires the native app','',4000);
});

// Grouped file picker: cluster similarly-named files into one multi-part entry
function makeGroupedFilePicker() {
  const inp = document.createElement('input');
  inp.type='file'; inp.accept='.epub,.pdf,.mp3,.m4b,.m4a,.flac,.ogg,.opus'; inp.multiple=true;
  inp.onchange = async()=>{
    closePicker();
    const files = Array.from(inp.files||[]);
    if(!files.length) return;
    showLoad(`Importing ${files.length} file${files.length>1?'s':''}…`);

    const audioExts = new Set(['mp3','m4b','m4a','flac','ogg','opus']);

    const normalizeBase = (name)=>{
      if(!name) return '';
      let base = name.split(/\\|\//).pop();
      base = base.replace(/\.[^/.]+$/,'');
      base = base.replace(/\s*\(?\b(?:part|pt|disc|cd|volume|vol|v)\b\s*\.?\s*\(?\d+\)?$/i,'');
      base = base.replace(/[\s._-]*\(?\d{1,3}\)?$/i,'');
      base = base.replace(/[\s._-]+/g,' ');
      return base.trim().toLowerCase();
    };

    const items = files.map(f=>({file:f,name:f.name,uri:URL.createObjectURL(f),format:(f.name.split('.').pop()||'').toLowerCase()}));
    const groups = {};
    for(const it of items){
      const b = normalizeBase(it.name||it.uri||'');
      (groups[b]=groups[b]||[]).push(it);
    }

    for(const gKey of Object.keys(groups)){
      const g = groups[gKey];
      if(g.length>1){
        const parts = g.map(p=>({name:p.name,uri:p.uri,file:p.file,format:p.format}));
        const allAudio = parts.every(p=>audioExts.has(p.format));
        const entry = {
          id: Date.now()+Math.random(),
          uri: parts[0]?.uri || null,
          fileName: parts[0]?.name || 'Multiple files',
          format: allAudio ? 'audiobook-folder' : 'multi-file',
          source: 'local', status: 'imported', parts, title: guessTitle(parts[0]?.name || 'Multiple files')
        };
        // Attempt to parse author/title from first part filename
        try{ const pa = parseTitleAuthor(parts[0]?.name); if(pa){ if(pa.title) entry.title = pa.title; if(pa.author) entry.author = pa.author; } }catch(e){}
        S.library.unshift(entry);
        if(S.settings.autoFetch && entry.title){
          try{
            const q = `${entry.title}${entry.author? ' '+entry.author : ''}`;
            const results = await fetchAll(q);
            await applyBestMetadata(S.library[0], results);
          }catch(e){}
        }
      } else {
        const f = g[0];
        const fmt = f.name.split('.').pop().toLowerCase();
        const entry = {
          id: Date.now()+Math.random(), fileName:f.name, format:fmt,
          title: guessTitle(f.name), author:'', narrator:'', series:'', year:'',
          publisher:'', genre:'', isbn:'', description:'', language:'',
          coverBase64:null, coverMime:null, duration:null, bitrate:null, sampleRate:null, channels:null,
        };
        try{ const pa = parseTitleAuthor(f.name); if(pa){ if(pa.title) entry.title = pa.title; if(pa.author) entry.author = pa.author; } }catch(e){}
        try{
          const ab = await f.file.arrayBuffer();
          if(fmt==='epub') { Object.assign(entry, await parseEpub(ab, f.name)); }
        }catch(e){}
        S.library.unshift(entry);
        if(S.settings.autoFetch && entry.title){
          try{
            const q = `${entry.title}${entry.author? ' '+entry.author : ''}`;
            const results = await fetchAll(q);
            await applyBestMetadata(S.library[0], results);
          }catch(e){}
        }
      }
    }

    hideLoad();
    saveLibrary();
    renderLibrary();
    toast(`Added ${files.length} book${files.length>1?'s':''}`, 'success');
  };
  return inp;
}

// ── EPUB parser (minimal) ─────────────────────────────────────────────────────
async function parseEpub(ab, fileName) {
  try {
    const { ZipReader, BlobReader, TextWriter, BlobWriter } = await import('https://cdn.jsdelivr.net/npm/@zip.js/zip.js@2.7.32/+esm');
    const zr      = new ZipReader(new BlobReader(new Blob([ab])));
    const entries = await zr.getEntries();
    const byName  = {};
    entries.forEach(e=>byName[e.filename]=e);

    const containerEntry = byName['META-INF/container.xml'];
    if(!containerEntry) return {};
    const containerXml = await containerEntry.getData(new TextWriter());
    const opfMatch = containerXml.match(/full-path="([^"]+\.opf)"/i);
    if(!opfMatch) return {};

    const opfEntry = byName[opfMatch[1]];
    if(!opfEntry) return {};
    const opf = await opfEntry.getData(new TextWriter());
    await zr.close();

    const get = tag=>{const m=opf.match(new RegExp(`<dc:${tag}[^>]*>([^<]+)<\/dc:${tag}>','i'`));return m?m[1].trim():''};
    const title       = opf.match(/<dc:title[^>]*>([^<]+)<\/dc:title>/i)?.[1]?.trim() || '';
    const author      = opf.match(/<dc:creator[^>]*>([^<]+)<\/dc:creator>/i)?.[1]?.trim() || '';
    const publisher   = opf.match(/<dc:publisher[^>]*>([^<]+)<\/dc:publisher>/i)?.[1]?.trim() || '';
    const date        = opf.match(/<dc:date[^>]*>([^<]+)<\/dc:date>/i)?.[1]?.trim() || '';
    const description = opf.match(/<dc:description[^>]*>([^<]+)<\/dc:description>/i)?.[1]?.trim() || '';
    const language    = opf.match(/<dc:language[^>]*>([^<]+)<\/dc:language>/i)?.[1]?.trim() || '';
    const identifier  = opf.match(/<dc:identifier[^>]*>([^<]+)<\/dc:identifier>/i)?.[1]?.trim() || '';
    return { title, author, publisher, year:date.slice(0,4), description, language, isbn:identifier };
  } catch { return {}; }
}

// ── Library ───────────────────────────────────────────────────────────────────
const FMT_LABELS = {epub:'EPUB',pdf:'PDF',mp3:'MP3',m4b:'M4B',m4a:'M4A',flac:'FLAC',ogg:'OGG',opus:'OPUS'};
const AUDIO_FMTS = new Set(['mp3','m4b','m4a','flac','ogg','opus']);

function renderLibrary() {
  const filtered = S.filterFmt==='all' ? S.library : S.library.filter(b=>b.format===S.filterFmt);
  D.bookGrid.querySelectorAll('.bcard').forEach(el=>el.remove());
  D.emptyState.style.display = filtered.length ? 'none' : 'flex';
  if(!filtered.length) return;

  const frag = document.createDocumentFragment();
  filtered.forEach((book,i)=>{
    const realIdx = S.library.indexOf(book);
    const card    = document.createElement('div');
    card.className='bcard fu';
    card.style.animationDelay=`${Math.min(i*30,300)}ms`;
    const grad = `cg${i%6}`;
    const thumbSrc = book.coverBase64
      ? `data:${book.coverMime||'image/jpeg'};base64,${book.coverBase64}`
      : book.coverUrl || null;
    const safeThumb = sanitizeUri(thumbSrc);
    const coverHtml = safeThumb
      ? `<img class="bcover-img" src="${safeThumb}" alt="" loading="lazy"/>`
      : `<div class="bcover-ph ${grad}"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.45)" stroke-width="1.5"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg></div>`;
    const partsCount = Array.isArray(book.parts)?book.parts.length: (book.format && AUDIO_FMTS.has(book.format)?1:0);
    card.innerHTML=`<div class="bcover-wrap">${coverHtml}<span class="bfmt-badge fmt-${book.format}">${FMT_LABELS[book.format]||book.format.toUpperCase()}</span></div><div class="btitle">${esc(book.title||book.fileName)}</div><div class="bauthor">${esc(book.author||'—')}</div><div class="card-actions"><button class="card-play ibtn" data-idx="${realIdx}" title="Play">▶</button><div class="parts-badge">${partsCount>1?partsCount+' parts':(partsCount===1?'audio':'')}</div></div>`;
    card.addEventListener('click',()=>openEditor(realIdx));
    frag.appendChild(card);
  });
  D.bookGrid.appendChild(frag);
  // Attach play handlers for card-play buttons
  D.bookGrid.querySelectorAll('.card-play').forEach(btn=>{
    btn.addEventListener('click',async(e)=>{
      e.stopPropagation();
      const idx = Number(btn.dataset.idx);
      const book = S.library[idx]; if(!book) return;
      try{
        if(Array.isArray(book.parts) && book.parts.length){ const u = book.parts[0].uri; if(u){ const a=new Audio(u); await a.play(); } }
        else if(book.uri){ const a=new Audio(book.uri); await a.play(); }
      }catch(err){ toast('Playback failed'); }
    });
  });
}

// Filter pills
D.filterStrip.addEventListener('click',e=>{
  const p = e.target.closest('.fpill'); if(!p) return;
  D.filterStrip.querySelectorAll('.fpill').forEach(x=>x.classList.remove('active'));
  p.classList.add('active');
  S.filterFmt = p.dataset.fmt;
  renderLibrary();
});

// ── Editor ────────────────────────────────────────────────────────────────────
function openEditor(idx) {
  S.activeIdx = idx;
  populate(S.library[idx]);
  D.editorScr.classList.add('open');
  // ensure meta panel visible on desktop
  if(window.innerWidth>900 && D.metaPanel) D.metaPanel.style.display='block';
}
function closeEditor() {
  D.editorScr.classList.remove('open');
  closeResults();
  S.activeIdx=-1;
  if(D.metaPanel) D.metaPanel.style.display='none';
}
// ensure back button exists inside .enav (moved from hero content)
if(!document.getElementById('btnBack')){
  const _enav = document.querySelector('.enav');
  if(_enav){
    const b = document.createElement('button');
    b.className = 'enav-back'; b.id = 'btnBack';
    b.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="15 18 9 12 15 6"/></svg>Library';
    _enav.appendChild(b);
  }
}

$('btnBack').addEventListener('click',()=>{ if(history.state && history.state.page==='editor'){ try{ history.back(); }catch(e){ closeEditor({back:false}); } } else closeEditor({back:false}); });

function populate(b) {
  D.eFormat.textContent  = FMT_LABELS[b.format]||b.format?.toUpperCase()||'—';
  D.eTitle.textContent   = b.title  || b.fileName || '—';
  D.eAuthor.textContent  = b.author || '—';

  const coverSrc = b.coverBase64
    ? `data:${b.coverMime||'image/jpeg'};base64,${b.coverBase64}`
    : b.coverUrl || null;
  const safeCoverSrc = sanitizeUri(coverSrc);
  // If meta panel is visible on wide screens, show artwork there instead of duplicating in hero
  const preferMeta = D.metaPanel && window.innerWidth>900;
  if(safeCoverSrc && !preferMeta){
    D.eCover.src = safeCoverSrc; D.eCover.style.display = 'block'; D.eCoverPh.style.display = 'none';
    D.eBg.style.backgroundImage = `url('${safeCoverSrc}')`;
  } else {
    D.eCover.style.display = 'none'; D.eCoverPh.style.display = 'flex';
    D.eBg.style.backgroundImage = '';
  }

  const isAudio = AUDIO_FMTS.has(b.format);
  D.aStrip.style.display = isAudio?'flex':'none';
  if(isAudio){
    D.aDur.textContent = fmtDur(b.duration);
    D.aBit.textContent = b.bitrate ? `${b.bitrate} kbps`:'—';
    D.aSR.textContent  = b.sampleRate ? `${(b.sampleRate/1000).toFixed(1)} kHz`:'—';
    D.aCh.textContent  = b.channels ? (b.channels===1?'Mono':'Stereo'):'—';
  }

  D.fTitle.value    = b.title||''; D.fAuthor.value   = b.author||'';
  D.fNarrator.value = b.narrator||''; D.fSeries.value  = b.series||'';
  D.fYear.value     = b.year||''; D.fPub.value      = b.publisher||'';
  D.fGenre.value    = b.genre||''; D.fISBN.value    = b.isbn||'';
  D.fLang.value     = b.language||''; D.fDesc.value  = b.description||'';

  D.fTitle.oninput  = ()=>{ D.eTitle.textContent  = D.fTitle.value||'—'; };
  D.fAuthor.oninput = ()=>{ D.eAuthor.textContent = D.fAuthor.value||'—'; };

  D.eScroll.scrollTop = 0;

  // Render parts list (for grouped / multi-file entries)
  try {
    const partsEl = D.partsList;
    if(partsEl){
      if(Array.isArray(b.parts) && b.parts.length){
        partsEl.innerHTML = '';
        b.parts.forEach((p,i)=>{
          const name = p.name||p.fileName||`Part ${i+1}`;
          const fmt = (p.format||'').toUpperCase();
          const wrapper = document.createElement('div');
          wrapper.style.cssText = 'display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-radius:10px;background:rgba(255,255,255,0.02);margin-bottom:8px';
          const left = document.createElement('div'); left.style.cssText = 'display:flex;align-items:center;gap:12px';
          const titleDiv = document.createElement('div'); titleDiv.style.fontSize='13px'; titleDiv.textContent = name;
          const fmtDiv = document.createElement('div'); fmtDiv.style.cssText = 'font-size:11px;color:var(--t3)'; fmtDiv.textContent = fmt;
          left.appendChild(titleDiv); left.appendChild(fmtDiv);
          const right = document.createElement('div'); right.style.display='flex'; right.style.alignItems='center';
          // play button (only for audio formats and safe URIs)
          const candidateUri = sanitizeUri(p.uri||'');
          if(AUDIO_FMTS.has((p.format||'').toLowerCase()) && candidateUri){
            const playBtn = document.createElement('button'); playBtn.className='ibtn part-play'; playBtn.title='Play'; playBtn.style.marginRight='8px';
            playBtn.textContent = '▶'; playBtn.dataset.uri = candidateUri;
            playBtn.addEventListener('click',()=>{ try{ const a=new Audio(playBtn.dataset.uri); a.play(); }catch(e){} });
            right.appendChild(playBtn);
          }
          // download link (only if uri is safe)
          if(candidateUri){
            const dl = document.createElement('a'); dl.className='gbtn'; dl.href = candidateUri; dl.download = name; dl.style.cssText='padding:6px 10px;margin-left:8px'; dl.textContent='Download';
            right.appendChild(dl);
          }
          wrapper.appendChild(left); wrapper.appendChild(right);
          partsEl.appendChild(wrapper);
        });
      } else {
        const nod = document.createElement('div'); nod.style.color='var(--t3)'; nod.style.fontSize='13px'; nod.textContent='No extra parts'; partsEl.innerHTML=''; partsEl.appendChild(nod);
      }
    }
  } catch(e){ console.warn('Render parts failed', e); }

  // Populate meta panel (right-hand summary)
  try{
    const mp = D.metaPanel;
    if(mp){
      D.mpTitle.textContent = b.title||b.fileName||'—';
      D.mpAuthor.textContent = b.author||'—';
      const csrc = b.coverBase64 ? `data:${b.coverMime||'image/jpeg'};base64,${b.coverBase64}` : b.coverUrl || null;
      const safeCsrc = sanitizeUri(csrc);
      if(safeCsrc){ D.mpCoverImg.src = safeCsrc; D.mpCoverImg.style.display='block'; D.mpCoverPh.style.display='none'; }
      else { D.mpCoverImg.style.display='none'; D.mpCoverPh.style.display='block'; }
      // parts in meta panel
      const mpParts = D.mpParts; if(mpParts){
        if(Array.isArray(b.parts) && b.parts.length){
          mpParts.innerHTML = '';
          b.parts.forEach((p,i)=>{
            const row = document.createElement('div'); row.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:6px 0';
            const left = document.createElement('div'); left.style.fontSize='13px'; left.textContent = p.name||p.fileName||`Part ${i+1}`;
            const right = document.createElement('div');
            const u = sanitizeUri(p.uri||'');
            if(u){
              const btn = document.createElement('button'); btn.className='gbtn'; btn.style.padding='6px 10px'; btn.dataset.uri = u; btn.textContent='Play';
              btn.addEventListener('click',()=>{ try{ (new Audio(u)).play(); }catch(e){} });
              right.appendChild(btn);
            }
            row.appendChild(left); row.appendChild(right); mpParts.appendChild(row);
          });
        } else {
          mpParts.innerHTML = '';
          const n = document.createElement('div'); n.style.color='var(--t3)'; n.textContent='No extra parts'; mpParts.appendChild(n);
        }
      }
      if(window.innerWidth>900) mp.style.display='block'; else mp.style.display='none';
    }
  }catch(e){console.warn('Meta panel populate failed',e)}
}

function collectForm() {
  const b = S.library[S.activeIdx]||{};
  return { ...b, title:D.fTitle.value, author:D.fAuthor.value, narrator:D.fNarrator.value,
    series:D.fSeries.value, year:D.fYear.value, publisher:D.fPub.value, genre:D.fGenre.value,
    isbn:D.fISBN.value, language:D.fLang.value, description:D.fDesc.value };
}

$('btnSave').addEventListener('click',()=>{
  if(S.activeIdx<0) return;
  S.library[S.activeIdx] = collectForm();
  saveLibrary();
  renderLibrary();
  toast('Saved!','success');
});

$('btnFetch').addEventListener('click',async()=>{
  const q = D.fTitle.value||D.fAuthor.value;
  if(!q){ toast('Enter a title or author first'); return; }
  showLoad('Searching all sources…');
  try {
    const results = await fetchAll(q);
    hideLoad();
    if(!results.length){ toast('No results found'); return; }
    D.rSheetTitle.textContent=`${results.length} Results`;
    renderResults(results, D.rList, applyResult);
    openResults();
  } catch(e){ hideLoad(); toast(`Search failed: ${e.message}`,'error'); }
});

$('btnCoverChange').addEventListener('click',()=>{
  const inp=document.createElement('input'); inp.type='file'; inp.accept='image/*';
  inp.onchange=async()=>{
    const f=inp.files[0]; if(!f) return;
    const b64=await blobToB64(f);
    const book=S.library[S.activeIdx];
    if(book){ book.coverBase64=b64.split(',')[1]; book.coverMime=f.type; book.coverUrl=b64; }
    D.eCover.src=b64; D.eCover.style.display='block'; D.eCoverPh.style.display='none';
    D.eBg.style.backgroundImage=`url('${b64}')`;
    saveLibrary();
    renderLibrary();
    toast('Cover updated','success');
  };
  inp.click();
});

// Cover zoom / viewer
$('btnCoverZoom')?.addEventListener('click',()=>{
  const src = D.eCover.src || D.mpCoverImg?.src || '';
  if(!src) return;
  const cv = $('coverViewer'), cimg=$('coverViewImg');
  cimg.src = src; cv.style.display='flex'; setTimeout(()=>cv.classList.add('vis'),20);
});
$('coverViewer')?.addEventListener('click',()=>{ const cv=$('coverViewer'); cv.classList.remove('vis'); setTimeout(()=>cv.style.display='none',250); });

// Mobile meta-panel toggle
$('btnMetaToggle')?.addEventListener('click',()=>{
  D.editorScr.classList.toggle('meta-open');
  if(D.editorScr.classList.contains('meta-open')){
    D.metaPanel.style.display='block'; document.body.style.overflow='hidden';
  } else {
    D.metaPanel.style.display = window.innerWidth>900 ? 'block' : 'none'; document.body.style.overflow='';
  }
});
$('btnMetaClose')?.addEventListener('click',()=>{
  D.editorScr.classList.remove('meta-open'); D.metaPanel.style.display = window.innerWidth>900 ? 'block' : 'none'; document.body.style.overflow='';
});

// Ensure meta panel visibility on open/close editor for mobile
const _openEditor = openEditor;
openEditor = function(idx, opts={push:true}){
  _openEditor(idx);
  // Save editor state to localStorage
  try {
    localStorage.setItem('bmg_editor_state', JSON.stringify({
      activeIdx: idx,
      timestamp: Date.now()
    }));
  } catch(e) {
    console.warn('Failed to save editor state:', e);
  }
  if(window.innerWidth<=900){ D.metaPanel.style.display='none'; D.editorScr.classList.remove('meta-open'); }
  if(opts.push){
    try{ history.pushState({page:'editor', idx}, '', location.pathname + location.search); }catch(e){}
  }
};
const _closeEditor = closeEditor;
closeEditor = function(opts={back:true}){
  // Clear editor state from localStorage
  try {
    localStorage.removeItem('bmg_editor_state');
  } catch(e) {
    console.warn('Failed to clear editor state:', e);
  }
  // If caller wants to navigate back in history, prefer history.back() so the browser back behaves naturally
  if(opts.back && history.state && history.state.page==='editor'){
    try{ history.back(); return; }catch(e){}
  }
  _closeEditor(); D.editorScr.classList.remove('meta-open'); D.metaPanel.style.display='none'; document.body.style.overflow='';
};

// Handle browser / home-screen back behavior
window.addEventListener('popstate',(e)=>{
  const st = e.state || {};
  if(st.page==='editor'){
    // open editor for given index without pushing another state
    if(typeof st.idx === 'number') openEditor(st.idx, {push:false});
  } else {
    // any other state -> ensure editor closed
    if(S.activeIdx>=0 || D.editorScr.classList.contains('open')){
      _closeEditor(); S.activeIdx=-1; D.editorScr.classList.remove('meta-open'); D.metaPanel.style.display='none';
    }
  }
});


// Results sheet
function openResults(){ D.rBack.style.display='block'; D.rSheet.style.display='flex'; requestAnimationFrame(()=>D.rSheet.classList.add('open')); }
function closeResults(){ D.rSheet.classList.remove('open'); setTimeout(()=>{ D.rBack.style.display='none'; D.rSheet.style.display='none'; },400); }
$('btnCloseR').addEventListener('click',closeResults);
D.rBack.addEventListener('click',closeResults);

async function applyResult(r) {
  closeResults();
  if(r.title)       D.fTitle.value    = r.title;
  if(r.author)      D.fAuthor.value   = r.author;
  if(r.narrator)    D.fNarrator.value = r.narrator;
  if(r.publisher)   D.fPub.value      = r.publisher;
  if(r.year)        D.fYear.value     = r.year;
  if(r.isbn)        D.fISBN.value     = r.isbn;
  if(r.genre)       D.fGenre.value    = r.genre;
  if(r.language)    D.fLang.value     = r.language;
  if(r.description) D.fDesc.value     = r.description;
  D.eTitle.textContent  = D.fTitle.value  || '—';
  D.eAuthor.textContent = D.fAuthor.value || '—';
  if(r.coverUrl){
    // Set img src directly — browsers handle CORS for <img>, unlike fetch()
    D.eCover.src=r.coverUrl;
    D.eCover.style.display='block';
    D.eCoverPh.style.display='none';
    D.eBg.style.backgroundImage=`url('${r.coverUrl}')`;
    const book=S.library[S.activeIdx];
    if(book){ book.coverUrl=r.coverUrl; }
    renderLibrary();
    // Attempt blob conversion in background for local saving
    fetch(r.coverUrl).then(res=>res.blob()).then(async blob=>{
      const b64=await blobToB64(blob);
      if(book){ book.coverBase64=b64.split(',')[1]; book.coverMime=blob.type; }
      renderLibrary();
    }).catch(()=>{});
  }
  toast('Applied!','success');
}

// ── API Fetch ─────────────────────────────────────────────────────────────────
const TIMEOUT=9000;
function ft(url,opts={}){
  const c=new AbortController(); const t=setTimeout(()=>c.abort(),TIMEOUT);
  return fetch(url,{...opts,signal:c.signal}).finally(()=>clearTimeout(t));
}

async function fetchAll(query) {
  const q=encodeURIComponent(query);
  const [g,ol,it,mb]=await Promise.allSettled([fetchGB(q),fetchOL(q),fetchIT(q),fetchMB(q)]);
  return [...(g.status==='fulfilled'?g.value:[]),...(ol.status==='fulfilled'?ol.value:[]),
    ...(it.status==='fulfilled'?it.value:[]),...(mb.status==='fulfilled'?mb.value:[])];
}

async function fetchGB(q){
  try{
    const d=await (await ft(`https://www.googleapis.com/books/v1/volumes?q=${q}&maxResults=5`)).json();
    return (d.items||[]).map(it=>{const v=it.volumeInfo||{};return{source:'Google Books',
      title:v.title||'',author:(v.authors||[]).join(', '),publisher:v.publisher||'',
      year:(v.publishedDate||'').slice(0,4),isbn:(v.industryIdentifiers||[]).find(i=>i.type==='ISBN_13')?.identifier||'',
      description:sh(v.description||''),genre:(v.categories||[]).join(', '),language:v.language||'',
      coverUrl:v.imageLinks?.extraLarge||v.imageLinks?.large||v.imageLinks?.thumbnail||null};});
  }catch{return[]}
}

async function fetchOL(q){
  try{
    const d=await(await ft(`https://openlibrary.org/search.json?q=${q}&limit=5`)).json();
    return(d.docs||[]).slice(0,5).map(doc=>({source:'Open Library',title:doc.title||'',
      author:(doc.author_name||[]).join(', '),publisher:(doc.publisher||[]).join(', ').slice(0,80),
      year:doc.first_publish_year?String(doc.first_publish_year):'',isbn:(doc.isbn||[])[0]||'',
      language:(doc.language||[])[0]||'',genre:(doc.subject||[]).slice(0,3).join(', '),
      coverUrl:doc.cover_i?`https://covers.openlibrary.org/b/id/${doc.cover_i}-L.jpg`:null}));
  }catch{return[]}
}

async function fetchIT(q){
  try{
    const [a,e]=await Promise.allSettled([
      ft(`https://itunes.apple.com/search?term=${q}&media=audiobook&limit=4&entity=audiobook`).then(r=>r.json()),
      ft(`https://itunes.apple.com/search?term=${q}&media=ebook&limit=3&entity=ebook`).then(r=>r.json())]);
    return [...(a.status==='fulfilled'?a.value.results:[]),...(e.status==='fulfilled'?e.value.results:[])].slice(0,6).map(item=>({
      source:'iTunes / Audible',title:item.collectionName||item.trackName||'',author:item.artistName||'',
      narrator:item.authorName||'',publisher:item.publisherName||'',year:(item.releaseDate||'').slice(0,4),
      description:sh(item.description||item.longDescription||''),genre:item.primaryGenreName||'',
      coverUrl:(item.artworkUrl600||item.artworkUrl100||'').replace('100x100bb','600x600bb')}));
  }catch{return[]}
}

async function fetchMB(q){
  try{
    const d=await(await ft(`https://musicbrainz.org/ws/2/release/?query=release:${encodeURIComponent(`"${q}"`)}&limit=5&fmt=json`,
      {headers:{'User-Agent':'BookMetaGrabber/1.0 (test)'}})).json();
    const results=[];
    for(const rel of(d.releases||[]).slice(0,4)){
      let coverUrl=null;
      try{const cr=await ft(`https://coverartarchive.org/release/${rel.id}`,{headers:{Accept:'application/json'}});const crd=await cr.json();coverUrl=crd?.images?.[0]?.image||null;}catch{}
      results.push({source:'MusicBrainz',title:rel.title||'',author:rel['artist-credit']?.map(a=>a.artist?.name).join(', ')||'',year:(rel.date||'').slice(0,4),publisher:rel['label-info']?.[0]?.label?.name||'',coverUrl});
    }
    return results;
  }catch{return[]}
}

async function fetchAndEnrich(idx){
  const b=S.library[idx]; if(!b) return;
  try{
    const results=await fetchAll(b.title||b.author||b.fileName);
    if(!results.length) return;
    const best=results[0];
    if(!b.description&&best.description) b.description=best.description;
    if(!b.genre&&best.genre) b.genre=best.genre;
    if(!b.year&&best.year) b.year=best.year;
    if(!b.coverBase64&&best.coverUrl){
      try{const r=await fetch(best.coverUrl);const bl=await r.blob();const b64=await blobToB64(bl);b.coverBase64=b64.split(',')[1];b.coverMime=bl.type;}catch{}
    }
    saveLibrary();
    renderLibrary();
  }catch{}
}

// Apply best metadata result to an entry (title/author/cover/etc.)
async function applyBestMetadata(entry, results){
  if(!entry || !Array.isArray(results) || !results.length) return false;
  const best = results[0];
  try{
    if(best.title) entry.title = best.title;
    if(best.author) entry.author = best.author;
    if(best.narrator) entry.narrator = best.narrator;
    if(best.publisher) entry.publisher = best.publisher;
    if(best.year) entry.year = entry.year || best.year;
    if(best.isbn) entry.isbn = entry.isbn || best.isbn;
    if(best.genre) entry.genre = entry.genre || best.genre;
    if(best.language) entry.language = entry.language || best.language;
    if(best.description) entry.description = entry.description || best.description;
    if(best.coverUrl && !entry.coverBase64){
      try{
        const r = await fetch(best.coverUrl);
        const bl = await r.blob();
        const b64 = await blobToB64(bl);
        entry.coverBase64 = b64.split(',')[1];
        entry.coverMime = bl.type;
        entry.coverUrl = best.coverUrl;
      }catch(e){}
    }
    return true;
  }catch(e){return false}
}

// ── Result renderer ───────────────────────────────────────────────────────────
function renderResults(results, container, onApply){
  container.innerHTML='';
  const SC={'Google Books':'sg','Open Library':'so','iTunes / Audible':'si','MusicBrainz':'sm'};
  results.forEach((r,i)=>{
    const card=document.createElement('div');
    card.className='rcard fu'; card.style.animationDelay=`${Math.min(i*35,250)}ms`;
    const safeRcover = sanitizeUri(r.coverUrl||'');
    const th = safeRcover ? `<img class="rthumb" src="${safeRcover}" alt="" loading="lazy" onerror="this.style.display='none'"/>` : `<div class="rthumb-ph"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/></svg></div>`;
    card.innerHTML=`${th}<div class="rinfo"><div class="rtitle">${esc(r.title||'—')}</div><div class="rauthor">${esc(r.author||'—')}</div><div class="rmeta">${r.year?`<span style="font-size:11px;color:var(--t3)">${esc(r.year)}</span>`:''}<span class="stag ${SC[r.source]||'sg'}">${esc(r.source)}</span></div></div>`;
    card.addEventListener('click',()=>onApply(r));
    container.appendChild(card);
  });
}

// ── Global Search Tab ─────────────────────────────────────────────────────────
let sdeb;
D.gSearch.addEventListener('input',()=>{
  const q=D.gSearch.value.trim();
  D.btnSClear.classList.toggle('hidden',!q);
  clearTimeout(sdeb);
  if(!q){ D.sResults.innerHTML='<div class="sph"><p>Search all sources at once<br/>and tap a result to apply it</p></div>'; return; }
  sdeb=setTimeout(()=>runSearch(q),600);
});
D.gSearch.addEventListener('keydown',e=>{ if(e.key==='Enter'){ clearTimeout(sdeb); runSearch(D.gSearch.value.trim()); } });
$('btnSClear').addEventListener('click',()=>{ D.gSearch.value=''; D.btnSClear.classList.add('hidden'); D.sResults.innerHTML='<div class="sph"><p>Search all sources at once<br/>and tap a result to apply it</p></div>'; });

async function runSearch(q){
  if(!q) return;
  showLoad('Searching…'); D.sResults.innerHTML='';
  try{
    const results=await fetchAll(q); hideLoad();
    if(!results.length){ D.sResults.innerHTML='<div class="sph"><p>No results found</p></div>'; return; }
    renderResults(results, D.sResults, r=>{
      toast('Open a book to apply metadata','',3000);
    });
  } catch(e){ hideLoad(); D.sResults.innerHTML='<div class="sph"><p>Search failed</p></div>'; }
}

// Source chips (toggle, visual only)
document.querySelectorAll('.schip').forEach(c=>c.addEventListener('click',()=>c.classList.toggle('active')));

// ── Settings ──────────────────────────────────────────────────────────────────
$('togAutoFetch').addEventListener('click',()=>{
  S.settings.autoFetch=!S.settings.autoFetch;
  $('autoFetchToggle').classList.toggle('on',S.settings.autoFetch);
});
$('settGDrive').addEventListener('change',()=>{ S.settings.gDriveId=$('settGDrive').value.trim(); toast('Settings saved','success'); });
$('btnClearLib').addEventListener('click', async ()=>{
  const ok = await showConfirm('Clear Library?', 'This will permanently remove all items from your library. This action cannot be undone.', 'Yes, Clear All');
  if(!ok) return;
  S.library=[]; S.activeIdx=-1; saveLibrary(); renderLibrary(); toast('Library cleared');
});

// ── Helpers ───────────────────────────────────────────────────────────────────
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
// Return a sanitized URI or null if unsafe. Allows relative URLs, http(s), blob, and safe data: types (image/audio/pdf/octet-stream).
function sanitizeUri(u){
  if(!u) return null;
  try{
    const s = String(u).trim();
    if(!s) return null;
    // reject javascript: and other potentially dangerous schemes
    if(/^\s*javascript:/i.test(s)) return null;
    // Absolute scheme (e.g., https:, data:, blob:)
    const m = s.match(/^([a-zA-Z][a-zA-Z0-9+.-]*):/);
    if(m){
      const scheme = m[1].toLowerCase();
      if(['http','https','blob','file'].includes(scheme)) return s;
      if(scheme==='data'){
        // allow data:audio/, data:image/, data:application/pdf, data:application/octet-stream
        if(/^data:(audio|image)\//i.test(s)) return s;
        if(/^data:application\/(pdf|octet-stream)/i.test(s)) return s;
        return null;
      }
      return null;
    }
    // Relative URLs (start with / or no scheme) — allow
    if(/^[./]/.test(s) || !/[:\/\\]/.test(s)) return s;
    return null;
  }catch(e){return null}
}
function sh(s){return s.replace(/<[^>]+>/g,'').replace(/\s+/g,' ').trim()}
function guessTitle(n){
  if(!n) return '';
  let s = String(n).replace(/\.[^.]+$/,'');
  s = s.replace(/[_\-.]+/g,' ').replace(/\s+/g,' ').trim();
  // Remove common part/volume/disc markers like "part 1", "pt 01", "disc 2", "vol 1" etc.
  s = s.replace(/\s*\(?\b(?:part|pt|disc|cd|volume|vol|v)\b\s*\.?\s*\(?\d+\)?$/i,'');
  // Remove trailing numeric sequence like " - 01" or " (01)"
  s = s.replace(/[\s._-]*\(?\d{1,4}\)?$/,'');
  return s.trim();
}
// Try to parse "Author - Title" or "Title - Author" style filenames
function isNameLike(s){
  if(!s) return false;
  if(/\d/.test(s)) return false;
  const words = s.split(/\s+/).filter(Boolean);
  if(words.length>6) return false;
  const cap = words.filter(w=>/^[A-ZÀ-ÖØ-Ý][a-zà-öø-ÿ'`.-]*/.test(w)).length;
  return (cap/words.length) >= 0.5;
}
function parseTitleAuthor(filename){
  if(!filename) return null;
  let name = String(filename).replace(/\.[^.]+$/,'');
  // remove part markers and trailing numbers for analysis
  name = name.replace(/\s*\(?\b(?:part|pt|disc|cd|volume|vol|v)\b\s*\.?\s*\(?\d+\)?$/i,'');
  name = name.replace(/[\s._-]*\(?\d{1,4}\)?$/,'');
  // split on common separators
  const parts = name.split(/\s[-–—|]\s/).map(p=>p.trim()).filter(Boolean);
  if(parts.length>=2){
    const left = parts[0], right = parts.slice(1).join(' - ');
    // if left looks like a name, treat left=author, right=title
    if(isNameLike(left) && !isNameLike(right)) return {author:left, title:right};
    // if right looks like a name, treat right=author
    if(isNameLike(right) && !isNameLike(left)) return {author:right, title:left};
    // fallback: prefer shorter side as author
    if(left.length <= right.length) return {author:left, title:right};
    return {author:right, title:left};
  }
  return null;
}
function fmtDur(s){if(!s) return'—';const h=Math.floor(s/3600),m=Math.floor((s%3600)/60);return h>0?`${h}h ${String(m).padStart(2,'0')}m`:`${m}m`}
function blobToB64(blob){return new Promise((r,j)=>{const fr=new FileReader();fr.onload=()=>r(fr.result);fr.onerror=j;fr.readAsDataURL(blob)})}
function saveLibrary(){
  try{
    // Strip base64 covers before saving — they blow the 5MB localStorage limit.
    // coverUrl is kept so the image can be re-displayed from the remote URL.
    const slim=S.library.map(b=>({...b,coverBase64:null,coverMime:null}));
    localStorage.setItem('bmg_library',JSON.stringify(slim));
  }catch(e){console.warn('Save failed:',e);}
}
function loadLibrary(){try{const d=localStorage.getItem('bmg_library');return d?JSON.parse(d):[];}catch{return[];}}

// ── Init ──────────────────────────────────────────────────────────────────────
S.library = loadLibrary();

// Restore active tab from localStorage
try {
  const savedTab = localStorage.getItem('bmg_active_tab');
  if (savedTab && ['Library', 'Search', 'Settings'].includes(savedTab)) {
    S.activeTab = savedTab;
  }
} catch(e) {
  console.warn('Failed to load active tab:', e);
}

// Initialize with restored tab
switchTab(S.activeTab);

// Restore editor state if available
try {
  const editorState = localStorage.getItem('bmg_editor_state');
  if (editorState) {
    const state = JSON.parse(editorState);
    // Only restore if state is less than 30 minutes old to avoid stale data
    if (state.timestamp && (Date.now() - state.timestamp) < 30 * 60 * 1000) {
      const book = S.library[state.activeIdx];
      if (book) {
        // Open editor without pushing history state
        openEditor(state.activeIdx, {push: false});
      }
    } else {
      // Clear stale editor state
      localStorage.removeItem('bmg_editor_state');
    }
  }
} catch(e) {
  console.warn('Failed to restore editor state:', e);
  localStorage.removeItem('bmg_editor_state');
}

renderLibrary();
</script>
<script>
// Toggle classes on <html> depending on whether the app is running standalone (homescreen) or in-browser.
(function(){
  function updateDisplayMode(){
    const isStandalone = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches)
      || window.navigator.standalone === true
      || (window.matchMedia && window.matchMedia('(display-mode: fullscreen)').matches);
    document.documentElement.classList.toggle('standalone', !!isStandalone);
    document.documentElement.classList.toggle('browser', !isStandalone);
    // also update --safe-top/--safe-bottom vars for browsers that may not expose env() properly
    if(isStandalone){
      document.documentElement.style.setProperty('--safe-top', 'calc(env(safe-area-inset-top, 18px) + 12px)');
      document.documentElement.style.setProperty('--safe-bottom', 'calc(env(safe-area-inset-bottom, 12px) + 12px)');
    } else {
      document.documentElement.style.setProperty('--safe-top', 'calc(env(safe-area-inset-top, 10px) + 6px)');
      document.documentElement.style.setProperty('--safe-bottom', 'calc(env(safe-area-inset-bottom, 6px) + 6px)');
    }
  }
  updateDisplayMode();
  window.addEventListener('resize', updateDisplayMode);
  window.addEventListener('visibilitychange', updateDisplayMode);
  document.addEventListener('DOMContentLoaded', updateDisplayMode);
})();
// detect iOS devices and add an `ios` class to <html>
(function(){
  try{
    const ua = navigator.userAgent || '';
    const isi = /iPhone|iPad|iPod/i.test(ua) || (navigator.platform && /iPad|iPhone|iPod/.test(navigator.platform));
    if(isi) document.documentElement.classList.add('ios');
  }catch(e){}
})();
// Ensure default theme is dark unless user explicitly chose light
(function(){
  try{
    const stored = localStorage.getItem('bmg_theme');
    if(stored === 'light'){
      document.documentElement.classList.add('clean');
      document.documentElement.classList.remove('dark');
    } else {
      // default to dark
      document.documentElement.classList.remove('clean');
      document.documentElement.classList.add('dark');
      localStorage.setItem('bmg_theme','dark');
    }
    // set meta theme-color for status bar on mobile
    let m = document.querySelector('meta[name="theme-color"]');
    if(!m){ m = document.createElement('meta'); m.name='theme-color'; document.head.appendChild(m); }
    m.content = getComputedStyle(document.documentElement).getPropertyValue('--g-bg').trim() || '#0f1724';
  }catch(e){}
})();
// Fix potential initial layout fitting issues on some iOS WebViews by forcing a reflow
;(function(){
  function doReflow(){
    try{
      // small scroll to trigger layout, then back
      if('scrollRestoration' in history) history.scrollRestoration = 'manual';
      window.scrollTo(0,0);
      // force reflow
      document.body.getBoundingClientRect();
      window.dispatchEvent(new Event('resize'));
    }catch(e){}
  }
  window.addEventListener('load', ()=>{ setTimeout(doReflow, 120); setTimeout(doReflow, 600); });
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') setTimeout(doReflow,100); });
})();

// Remove stray "mobile only" text nodes that may have been injected accidentally
;(function(){
  function removeStray(){
    const walk = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null);
    const rem = [];
    while(walk.nextNode()){
      const t = walk.currentNode.nodeValue.trim().toLowerCase();
      if(t==='mobile only' || t==='mobile-only' || t==='mobileonly'){
        rem.push(walk.currentNode);
      }
    }
    rem.forEach(n=>{ if(n && n.parentNode) n.parentNode.removeChild(n); });
  }
  document.addEventListener('DOMContentLoaded', removeStray);
  window.addEventListener('load', removeStray);
})();
</script>
<script>
// Pull-to-refresh implementation (mobile)
(function(){
  const ptr = document.getElementById('ptr');
  const ptrText = document.getElementById('ptrText');
  const ptrIcon = document.getElementById('ptrIcon');
  if(!ptr) return;
  let startY = 0, dist = 0, pulling = false, refreshing = false;
  const THRESHOLD = 80;

  function onTouchStart(e){
    if(refreshing) return;
    if(document.scrollingElement && document.scrollingElement.scrollTop > 0) return;
    const t = e.touches ? e.touches[0] : e;
    startY = t.clientY; pulling = true; dist = 0;
  }
  function onTouchMove(e){
    if(!pulling || refreshing) return;
    const t = e.touches ? e.touches[0] : e;
    dist = t.clientY - startY;
    if(dist <= 0) return;
    // prevent native overscroll
    e.preventDefault();
    const pull = Math.min(dist, 140);
    if(pull > 12) ptr.classList.add('pull');
    ptr.style.transform = `translateY(${Math.min(pull-60, 48)}px)`;
    if(pull > THRESHOLD){ ptrText.textContent = 'Release to refresh'; ptr.classList.add('release'); }
    else { ptrText.textContent = 'Pull to refresh'; ptr.classList.remove('release'); }
  }
  function onTouchEnd(){
    if(!pulling) return; pulling = false;
    if(dist > THRESHOLD){
      // trigger refresh (perform full reload to ensure fresh state)
      refreshing = true; ptr.classList.add('refreshing'); ptrText.textContent = 'Refreshing…'; ptr.style.transform='translateY(48px)';
      setTimeout(()=>{ try{ location.reload(); }catch(e){ /* fallback: soft refresh */ try{ S.library = loadLibrary(); renderLibrary(); }catch{} } }, 120);
    } else {
      // animate hide
      ptr.className='ptr'; ptr.style.transform='translateY(-60px)'; ptrText.textContent='Pull to refresh'; ptr.classList.remove('release');
    }
    dist = 0;
  }

  window.addEventListener('touchstart', onTouchStart, {passive:false});
  window.addEventListener('touchmove', onTouchMove, {passive:false});
  window.addEventListener('touchend', onTouchEnd);
  // also support pointer events on some browsers
  window.addEventListener('pointerdown', e=>{ if(e.pointerType==='touch') onTouchStart(e); }, {passive:false});
  window.addEventListener('pointermove', e=>{ if(e.pointerType==='touch') onTouchMove(e); }, {passive:false});
  window.addEventListener('pointerup', e=>{ if(e.pointerType==='touch') onTouchEnd(e); });
})();
</script>
</body>
</html>
