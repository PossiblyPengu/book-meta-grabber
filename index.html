<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<title>Meta Grabber</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Figtree:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<style>
/* ══════════════════════════════════════════
   iOS LIQUID GLASS — BOOK META GRABBER
   ══════════════════════════════════════════ */
:root {
  --font: 'Figtree', -apple-system, 'SF Pro Display', system-ui, sans-serif;
  --g-bg:     rgba(255,255,255,0.07);
  --g-bg-h:   rgba(255,255,255,0.13);
  --g-border: rgba(255,255,255,0.13);
  --g-bord-h: rgba(255,255,255,0.28);
  --g-shadow: 0 8px 32px rgba(0,0,0,0.5), 0 1px 0 rgba(255,255,255,0.10) inset;
  --g-shadow-s: 0 4px 16px rgba(0,0,0,0.30);
  --blur:   blur(28px) saturate(200%);
  --blur-s: blur(14px) saturate(160%);
  --sheen:  linear-gradient(180deg, rgba(255,255,255,0.22) 0%, rgba(255,255,255,0.04) 35%, transparent 100%);
  --blue:   #60A5FA; --indigo: #818CF8; --teal: #34D399; --pink: #F472B6;
  --t1: rgba(255,255,255,0.92); --t2: rgba(255,255,255,0.58);
  --t3: rgba(255,255,255,0.34); --t4: rgba(255,255,255,0.16);
  --safe-top: 44px; --safe-bottom: 34px;
  --tab-h: calc(50px + var(--safe-bottom));
  --r-xl:20px; --r-lg:16px; --r-md:12px; --r-sm:9px; --r-xs:6px; --r-pill:999px;
  --touch: 44px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{width:100%;height:100%;overflow:hidden;font-family:var(--font);color:var(--t1);
  font-size:15px;line-height:1.5;-webkit-font-smoothing:antialiased;background:#050508;
  overscroll-behavior:none}

/* ── Ambient bg ── */
.bg{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden;
  background:radial-gradient(ellipse at 20% 5%, #0f172a 0%, #050508 60%)}
.orb{position:absolute;border-radius:50%;filter:blur(90px);will-change:transform}
.o1{width:500px;height:500px;background:radial-gradient(circle,#1e3a8a,transparent 70%);
  top:-120px;left:-80px;opacity:.7;animation:d1 24s linear infinite}
.o2{width:380px;height:380px;background:radial-gradient(circle,#5b21b6,transparent 70%);
  top:-60px;right:-50px;opacity:.5;animation:d2 30s linear infinite}
.o3{width:320px;height:320px;background:radial-gradient(circle,#064e3b,transparent 70%);
  bottom:8%;left:10%;opacity:.4;animation:d3 28s linear infinite}
.o4{width:260px;height:260px;background:radial-gradient(circle,#7c2d12,transparent 70%);
  bottom:-40px;right:-30px;opacity:.3;animation:d4 22s linear infinite}
.noise{position:absolute;inset:0;opacity:.028;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)'/%3E%3C/svg%3E")}
@keyframes d1{0%,100%{transform:translate(0,0) scale(1)}40%{transform:translate(55px,75px) scale(1.1)}70%{transform:translate(-25px,45px) scale(.95)}}
@keyframes d2{0%,100%{transform:translate(0,0)}55%{transform:translate(-75px,95px) scale(1.15)}}
@keyframes d3{0%,100%{transform:translate(0,0)}45%{transform:translate(85px,-55px)}80%{transform:translate(35px,30px)}}
@keyframes d4{0%,100%{transform:translate(0,0) scale(1)}60%{transform:translate(-55px,-70px) scale(1.2)}}

/* ── Glass ── */
.glass{position:relative;background:var(--g-bg);backdrop-filter:var(--blur);
  -webkit-backdrop-filter:var(--blur);border:1px solid var(--g-border);
  box-shadow:var(--g-shadow);overflow:hidden}
.glass::before{content:'';position:absolute;inset:0;background:var(--sheen);
  pointer-events:none;z-index:0;border-radius:inherit}
.gbar{background:var(--g-bg);backdrop-filter:var(--blur-s);-webkit-backdrop-filter:var(--blur-s);
  border:1px solid var(--g-border);position:relative;overflow:hidden}
.gbar::before{content:'';position:absolute;inset:0;background:var(--sheen);pointer-events:none}

/* ── Status bar ── */
.sbpad{height:var(--safe-top);position:relative;z-index:1;flex-shrink:0}

/* ── Tab screens ── */
.tab-screen{position:fixed;inset:0;bottom:var(--tab-h);z-index:1;display:flex;
  flex-direction:column;opacity:0;transform:translateY(10px);pointer-events:none;
  transition:opacity .28s ease,transform .28s cubic-bezier(.34,1.2,.64,1)}
.tab-screen.active{opacity:1;transform:translateY(0);pointer-events:auto}

/* ── Screen header ── */
.scr-hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;
  border-radius:0;border-left:none;border-right:none;border-top:none;flex-shrink:0}
.scr-title{font-size:28px;font-weight:700;letter-spacing:-.6px}
.hdr-actions{display:flex;gap:8px;align-items:center}

/* ── Icon btn ── */
.ibtn{width:var(--touch);height:var(--touch);border-radius:var(--r-md);border:1px solid var(--g-border);
  background:var(--g-bg);backdrop-filter:var(--blur-s);-webkit-backdrop-filter:var(--blur-s);
  color:var(--t1);cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:background .15s,transform .1s;position:relative;overflow:hidden;-webkit-tap-highlight-color:transparent}
.ibtn::before{content:'';position:absolute;inset:0;background:var(--sheen);pointer-events:none}
.ibtn:active{transform:scale(.92);background:var(--g-bg-h)}
.ibtn-accent{background:rgba(96,165,250,.22);border-color:rgba(96,165,250,.38);color:#BAE6FD}
.ibtn-accent:active{background:rgba(96,165,250,.35)}

/* ── Filter strip ── */
.filter-strip{display:flex;gap:8px;padding:12px 20px;overflow-x:auto;
  scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;scrollbar-width:none;flex-shrink:0}
.filter-strip::-webkit-scrollbar{display:none}
.fpill{flex-shrink:0;padding:7px 16px;border-radius:var(--r-pill);border:1px solid var(--g-border);
  background:var(--g-bg);color:var(--t2);font-family:var(--font);font-size:13px;font-weight:500;
  cursor:pointer;scroll-snap-align:start;transition:all .2s;-webkit-tap-highlight-color:transparent;white-space:nowrap}
.fpill.active{background:rgba(96,165,250,.22);border-color:rgba(96,165,250,.40);color:var(--blue)}

/* ── Book grid ── */
.book-grid{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:12px 16px 20px;
  display:grid;grid-template-columns:repeat(3,1fr);gap:12px;align-content:start}

/* ── Book card ── */
.bcard{display:flex;flex-direction:column;gap:6px;cursor:pointer;
  -webkit-tap-highlight-color:transparent;transition:transform .15s cubic-bezier(.34,1.3,.64,1)}
.bcard:active{transform:scale(.94)}
.bcover-wrap{width:100%;aspect-ratio:2/3;border-radius:var(--r-lg);overflow:hidden;
  background:var(--g-bg);border:1px solid var(--g-border);box-shadow:var(--g-shadow-s);position:relative}
.bcover-img{width:100%;height:100%;object-fit:cover}
.bcover-ph{width:100%;height:100%;display:flex;align-items:center;justify-content:center;
  flex-direction:column;gap:6px;color:rgba(255,255,255,.4)}
.bfmt-badge{position:absolute;top:6px;left:6px;padding:2px 6px;border-radius:var(--r-xs);
  font-size:9px;font-weight:700;letter-spacing:.04em}
.fmt-epub{background:rgba(99,102,241,.85);color:#fff}
.fmt-pdf{background:rgba(239,68,68,.85);color:#fff}
.fmt-mp3{background:rgba(16,185,129,.85);color:#fff}
.fmt-m4b{background:rgba(245,158,11,.85);color:#fff}
.fmt-flac{background:rgba(167,139,250,.85);color:#fff}
.fmt-ogg{background:rgba(20,184,166,.85);color:#fff}
.btitle{font-size:11px;font-weight:600;color:var(--t1);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.bauthor{font-size:10px;color:var(--t2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* ── Empty state ── */
.empty{grid-column:1/-1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:10px;padding:60px 32px;text-align:center;color:var(--t2)}
.empty-icon{width:80px;height:80px;border-radius:50%;background:rgba(255,255,255,.04);
  display:flex;align-items:center;justify-content:center;margin-bottom:8px}
.empty h3{font-size:20px;font-weight:600;color:var(--t1);letter-spacing:-.3px}
.empty p{font-size:14px;line-height:1.6}
.empty strong{color:var(--t1)}

/* ── Buttons ── */
.gbtn{display:inline-flex;align-items:center;justify-content:center;gap:7px;
  padding:12px 22px;border-radius:var(--r-md);border:1px solid var(--g-border);
  background:var(--g-bg);backdrop-filter:var(--blur-s);-webkit-backdrop-filter:var(--blur-s);
  color:var(--t1);font-family:var(--font);font-size:15px;font-weight:500;cursor:pointer;
  -webkit-tap-highlight-color:transparent;transition:background .15s,transform .1s;
  position:relative;overflow:hidden;width:100%}
.gbtn::before{content:'';position:absolute;inset:0;background:var(--sheen);pointer-events:none}
.gbtn:active{transform:scale(.96);background:var(--g-bg-h)}
.gbtn-primary{background:rgba(96,165,250,.22);border-color:rgba(96,165,250,.40);color:#BAE6FD}
.gbtn-primary:active{background:rgba(96,165,250,.35)}
.mt16{margin-top:16px}

/* ── Tab bar ── */
.tab-bar{position:fixed;bottom:0;left:0;right:0;height:var(--tab-h);z-index:100;
  display:flex;align-items:flex-start;justify-content:space-around;
  padding:6px 0 0;padding-bottom:var(--safe-bottom);border-radius:var(--r-xl) var(--r-xl) 0 0;
  border-bottom:none}
.tbtn{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:4px 0 0;
  background:none;border:none;color:var(--t3);font-family:var(--font);font-size:10px;
  font-weight:500;cursor:pointer;-webkit-tap-highlight-color:transparent;transition:color .2s;min-height:var(--touch)}
.tab-icon-wrap{width:30px;height:30px;display:flex;align-items:center;justify-content:center;
  border-radius:10px;transition:background .2s,transform .15s}
.tbtn.active{color:var(--blue)}
.tbtn.active .tab-icon-wrap{background:rgba(96,165,250,.18);transform:scale(1.05)}
.tbtn.active svg{stroke:var(--blue)}
.tbtn:active .tab-icon-wrap{transform:scale(.90)}

/* ── Backdrop ── */
.backdrop{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.45);
  backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);opacity:0;
  pointer-events:none;transition:opacity .3s}
.backdrop.vis{opacity:1;pointer-events:auto}

/* ── Bottom sheet ── */
.bsheet{position:fixed;bottom:0;left:0;right:0;z-index:201;
  background:rgba(14,14,20,.93);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);
  border:1px solid var(--g-border);border-bottom:none;border-radius:var(--r-xl) var(--r-xl) 0 0;
  padding:12px 20px calc(20px + var(--safe-bottom));
  transform:translateY(110%);transition:transform .4s cubic-bezier(.34,1.2,.64,1)}
.bsheet::before{content:'';position:absolute;inset:0;background:var(--sheen);pointer-events:none;border-radius:inherit}
.bsheet.open{transform:translateY(0)}
.sh-handle{width:36px;height:4px;border-radius:2px;background:rgba(255,255,255,.25);margin:0 auto 18px}
.sh-title{font-size:20px;font-weight:700;letter-spacing:-.4px;margin-bottom:20px}
.src-opts{display:flex;flex-direction:column;gap:10px;margin-bottom:16px}
.src-opt{display:flex;align-items:center;gap:14px;padding:14px 16px;border-radius:var(--r-lg);
  border:1px solid var(--g-border);background:var(--g-bg);cursor:pointer;
  -webkit-tap-highlight-color:transparent;transition:background .15s,transform .12s;
  min-height:var(--touch);position:relative;overflow:hidden}
.src-opt::before{content:'';position:absolute;inset:0;background:var(--sheen);pointer-events:none}
.src-opt:active{background:var(--g-bg-h);transform:scale(.98)}
.src-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.src-info{flex:1;display:flex;flex-direction:column;gap:2px;text-align:left}
.src-name{font-size:15px;font-weight:600;color:var(--t1)}
.src-sub{font-size:12px;color:var(--t2)}

/* ── Search tab ── */
.search-container{flex:1;display:flex;flex-direction:column;overflow:hidden;padding:12px 16px 0;gap:12px}
.sinput-wrap{display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:var(--r-lg);color:var(--t2)}
.sinput{flex:1;background:none;border:none;color:var(--t1);font-family:var(--font);font-size:15px;outline:none;-webkit-appearance:none}
.sinput::placeholder{color:var(--t3)}
.sclear{background:none;border:none;color:var(--t3);cursor:pointer;padding:4px;display:flex;align-items:center}
.sclear.hidden{display:none}
.src-chips{display:flex;gap:8px;overflow-x:auto;scrollbar-width:none;flex-shrink:0}
.src-chips::-webkit-scrollbar{display:none}
.schip{flex-shrink:0;padding:6px 14px;border-radius:var(--r-pill);border:1px solid var(--g-border);
  background:var(--g-bg);color:var(--t3);font-family:var(--font);font-size:12px;font-weight:500;
  cursor:pointer;transition:all .18s;-webkit-tap-highlight-color:transparent}
.schip.active{background:rgba(96,165,250,.20);border-color:rgba(96,165,250,.38);color:var(--blue)}
.sresults{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;display:flex;flex-direction:column;gap:10px}
.sph{flex:1;display:flex;align-items:center;justify-content:center;text-align:center;
  color:var(--t3);font-size:14px;line-height:1.6;padding:60px 0}

/* ── Settings tab ── */
.settings-scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:16px;
  display:flex;flex-direction:column;gap:20px;padding-bottom:32px}
.sgroup{border-radius:var(--r-xl);overflow:hidden;display:flex;flex-direction:column}
.slabel{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;
  color:var(--t3);padding:14px 16px 8px}
.srow{display:flex;align-items:center;justify-content:space-between;padding:13px 16px;
  min-height:var(--touch);border-top:1px solid var(--g-border);cursor:pointer;
  -webkit-tap-highlight-color:transparent;background:transparent;border-left:none;
  border-right:none;border-bottom:none;font-family:var(--font)}
.srow:first-of-type{border-top:none}
.srow-label{font-size:15px;color:var(--t1)}
.srow-val{font-size:14px;color:var(--t2)}
.sinp{margin:0 12px 12px;border-radius:var(--r-md);padding:11px 14px;font-size:14px;
  width:calc(100% - 24px);background:rgba(255,255,255,.06);border:1px solid var(--g-border);
  color:var(--t1);font-family:var(--font);outline:none;-webkit-appearance:none}
.sinp:focus{background:rgba(96,165,250,.08);border-color:rgba(96,165,250,.45)}
.shint{font-size:12px;color:var(--t3);padding:0 16px 14px;line-height:1.5}
.toggle{width:48px;height:28px;border-radius:14px;background:rgba(255,255,255,.15);
  position:relative;transition:background .25s;flex-shrink:0}
.toggle.on{background:#34D399}
.tog-knob{position:absolute;top:3px;left:3px;width:22px;height:22px;border-radius:50%;
  background:white;box-shadow:0 2px 6px rgba(0,0,0,.3);transition:transform .25s cubic-bezier(.34,1.2,.64,1)}
.toggle.on .tog-knob{transform:translateX(20px)}
.danger{color:#F87171}

/* ── Editor full screen ── */
.editor-scr{position:fixed;inset:0;z-index:300;display:flex;flex-direction:column;
  transform:translateY(100%);transition:transform .45s cubic-bezier(.34,1.1,.64,1);background:#050508;overflow:hidden}
.editor-scr.open{transform:translateY(0)}

/* ── Hero ── */
.hero{position:relative;height:52vh;min-height:280px;max-height:380px;flex-shrink:0;overflow:hidden;background:#0a0a12}
.hero-bg{position:absolute;inset:-30px;background-size:cover;background-position:center;
  filter:blur(40px) saturate(160%);opacity:.6;transform:scale(1.1)}
.hero-cover{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);height:82%;
  width:auto;max-width:55%;object-fit:contain;border-radius:var(--r-lg);
  box-shadow:0 20px 60px rgba(0,0,0,.7);z-index:2}
.hero-cover-ph{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:2;
  display:flex;flex-direction:column;align-items:center;gap:8px;color:var(--t3)}
.hero-overlay{position:absolute;inset:0;
  background:linear-gradient(to bottom,rgba(5,5,8,.30) 0%,transparent 30%,transparent 50%,rgba(5,5,8,.88) 100%);z-index:3}
.enav{position:absolute;top:var(--safe-top);left:16px;right:16px;z-index:10;display:flex;
  align-items:center;justify-content:space-between;padding:8px 12px;border-radius:var(--r-lg)}
.enav-back{display:flex;align-items:center;gap:4px;background:none;border:none;color:var(--blue);
  font-family:var(--font);font-size:16px;font-weight:500;cursor:pointer;min-height:var(--touch);padding:6px 0}
.enav-actions{display:flex;gap:8px}
.hero-info{position:absolute;bottom:0;left:0;right:0;padding:16px 20px 14px;z-index:4;display:flex;flex-direction:column;gap:4px}
.hero-fmt{display:inline-block;padding:3px 9px;border-radius:var(--r-xs);font-size:10px;font-weight:700;
  letter-spacing:.06em;background:rgba(96,165,250,.25);color:var(--blue);border:1px solid rgba(96,165,250,.35);
  width:fit-content;margin-bottom:2px}
.hero-title{font-size:22px;font-weight:700;letter-spacing:-.5px;line-height:1.2;text-shadow:0 2px 8px rgba(0,0,0,.6)}
.hero-author{font-size:14px;color:var(--t2);text-shadow:0 1px 4px rgba(0,0,0,.6)}
.hero-cactions{display:flex;gap:8px;margin-top:8px}
.hcbtn{display:flex;align-items:center;gap:6px;padding:7px 14px;border-radius:var(--r-pill);
  border:1px solid rgba(255,255,255,.22);background:rgba(0,0,0,.35);backdrop-filter:blur(10px);
  -webkit-backdrop-filter:blur(10px);color:var(--t1);font-family:var(--font);font-size:12px;
  font-weight:500;cursor:pointer;-webkit-tap-highlight-color:transparent}
.hcbtn:active{background:rgba(255,255,255,.15)}

/* ── Editor scroll ── */
.escroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:16px;display:flex;flex-direction:column;gap:14px}
.epad{height:40px}

/* ── Audio strip ── */
.astrip{border-radius:var(--r-lg);display:flex;align-items:center;padding:14px 0}
.astat{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px}
.adiv{width:1px;height:28px;background:var(--g-border);flex-shrink:0}
.ast-val{font-size:15px;font-weight:600;font-variant-numeric:tabular-nums;color:var(--t1)}
.ast-lbl{font-size:10px;color:var(--t3);font-weight:500;text-transform:uppercase;letter-spacing:.05em}

/* ── Form cards ── */
.fcard{border-radius:var(--r-xl);display:flex;flex-direction:column}
.fgroup{padding:12px 16px;position:relative;z-index:1;display:flex;flex-direction:column;gap:5px}
.flabel{font-size:11px;font-weight:600;color:var(--t3);text-transform:uppercase;letter-spacing:.07em}
.fdiv{height:1px;background:var(--g-border);margin:0 16px}
.finput{width:100%;background:transparent;border:none;color:var(--t1);font-family:var(--font);
  font-size:15px;outline:none;-webkit-appearance:none;padding:0;min-height:28px}
.finput::placeholder{color:var(--t3)}
.ftarea{resize:none;line-height:1.5;min-height:90px}

/* ── Results half sheet ── */
.res-back{position:absolute;inset:0;background:rgba(0,0,0,.40);backdrop-filter:blur(3px);
  -webkit-backdrop-filter:blur(3px);z-index:10}
.res-sheet{position:absolute;bottom:0;left:0;right:0;z-index:11;border-radius:var(--r-xl) var(--r-xl) 0 0;
  display:flex;flex-direction:column;max-height:72vh;min-height:40vh;
  transform:translateY(100%);transition:transform .4s cubic-bezier(.34,1.15,.64,1);border-bottom:none}
.res-sheet.open{transform:translateY(0)}
.res-hdr{display:flex;align-items:center;justify-content:space-between;padding:16px 16px 12px;
  font-size:16px;font-weight:600;color:var(--t1);flex-shrink:0;position:relative;z-index:1}
.rlist{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:0 12px 20px;display:flex;flex-direction:column;gap:8px}

/* ── Result card ── */
.rcard{display:flex;gap:12px;padding:12px;border-radius:var(--r-lg);border:1px solid var(--g-border);
  background:var(--g-bg);cursor:pointer;-webkit-tap-highlight-color:transparent;
  transition:background .15s,transform .12s;position:relative;overflow:hidden;min-height:var(--touch)}
.rcard::before{content:'';position:absolute;inset:0;background:var(--sheen);pointer-events:none}
.rcard:active{background:var(--g-bg-h);transform:scale(.98)}
.rthumb{width:44px;height:62px;border-radius:7px;object-fit:cover;flex-shrink:0;background:var(--g-bg)}
.rthumb-ph{width:44px;height:62px;border-radius:7px;flex-shrink:0;background:var(--g-bg);
  display:flex;align-items:center;justify-content:center;color:var(--t4);border:1px solid var(--g-border)}
.rinfo{flex:1;min-width:0}
.rtitle{font-size:13px;font-weight:600;color:var(--t1);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-bottom:2px}
.rauthor{font-size:12px;color:var(--t2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-bottom:4px}
.rmeta{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.stag{display:inline-flex;align-items:center;padding:2px 7px;border-radius:var(--r-xs);font-size:9px;font-weight:700;letter-spacing:.04em}
.sg{background:rgba(59,130,246,.22);color:#93C5FD;border:1px solid rgba(59,130,246,.30)}
.so{background:rgba(16,185,129,.22);color:#6EE7B7;border:1px solid rgba(16,185,129,.30)}
.si{background:rgba(245,158,11,.22);color:#FCD34D;border:1px solid rgba(245,158,11,.30)}
.sm{background:rgba(167,139,250,.22);color:#C4B5FD;border:1px solid rgba(167,139,250,.30)}

/* ── Toast ── */
.toast{position:fixed;bottom:calc(var(--tab-h) + 16px);left:50%;transform:translateX(-50%) translateY(20px);
  max-width:calc(100vw - 48px);padding:11px 20px;border-radius:var(--r-pill);border:1px solid var(--g-border);
  background:rgba(20,20,28,.90);backdrop-filter:var(--blur-s);-webkit-backdrop-filter:var(--blur-s);
  box-shadow:var(--g-shadow);font-size:13px;font-weight:500;color:var(--t1);opacity:0;pointer-events:none;
  z-index:9999;text-align:center;white-space:nowrap;transition:opacity .25s,transform .3s cubic-bezier(.34,1.3,.64,1)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.in-editor{bottom:20px}

/* ── Loading pill ── */
.lpill{position:fixed;top:calc(var(--safe-top) + 16px);left:50%;transform:translateX(-50%);
  display:flex;align-items:center;gap:10px;padding:10px 18px;border-radius:var(--r-pill);
  z-index:9998;font-size:13px;font-weight:500;color:var(--t1);white-space:nowrap}
.spin{width:16px;height:16px;border-radius:50%;border:2px solid rgba(255,255,255,.15);
  border-top-color:var(--blue);animation:spin .75s linear infinite;flex-shrink:0}
@keyframes spin{to{transform:rotate(360deg)}}

/* ── Animations ── */
@keyframes fade-up{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
.fu{animation:fade-up .3s cubic-bezier(.34,1.2,.64,1) both}
.cg0{background:linear-gradient(135deg,#1e3a8a,#6366f1)}
.cg1{background:linear-gradient(135deg,#064e3b,#0f766e)}
.cg2{background:linear-gradient(135deg,#7c2d12,#c2410c)}
.cg3{background:linear-gradient(135deg,#4c1d95,#7c3aed)}
.cg4{background:linear-gradient(135deg,#0c4a6e,#0369a1)}
.cg5{background:linear-gradient(135deg,#831843,#be185d)}
</style>
</head>
<body>

<!-- Ambient bg -->
<div class="bg" aria-hidden="true">
  <div class="orb o1"></div><div class="orb o2"></div><div class="orb o3"></div><div class="orb o4"></div>
  <div class="noise"></div>
</div>
<div class="sbpad"></div>

<!-- ════════ LIBRARY ════════ -->
<div class="tab-screen active" id="scrLibrary">
  <header class="scr-hdr gbar">
    <h1 class="scr-title">Library</h1>
    <div class="hdr-actions">
      <button class="ibtn" id="btnSearch" aria-label="Search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      </button>
      <button class="ibtn ibtn-accent" id="btnAdd" aria-label="Add">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      </button>
    </div>
  </header>
  <div class="filter-strip" id="filterStrip">
    <button class="fpill active" data-fmt="all">All</button>
    <button class="fpill" data-fmt="epub">EPUB</button>
    <button class="fpill" data-fmt="pdf">PDF</button>
    <button class="fpill" data-fmt="mp3">MP3</button>
    <button class="fpill" data-fmt="m4b">M4B</button>
    <button class="fpill" data-fmt="flac">FLAC</button>
    <button class="fpill" data-fmt="ogg">OGG</button>
  </div>
  <div class="book-grid" id="bookGrid">
    <div class="empty" id="emptyState">
      <div class="empty-icon">
        <svg width="48" height="48" viewBox="0 0 48 48" fill="none"><circle cx="24" cy="24" r="20" fill="url(#eg)" opacity=".12"/><path d="M24 14v14M17 21l7-7 7 7" stroke="url(#eg)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 33h24" stroke="url(#eg)" stroke-width="2.5" stroke-linecap="round"/><defs><linearGradient id="eg" x1="10" y1="12" x2="38" y2="38" gradientUnits="userSpaceOnUse"><stop stop-color="#60A5FA"/><stop offset="1" stop-color="#A78BFA"/></linearGradient></defs></svg>
      </div>
      <h3>No books yet</h3>
      <p>Tap <strong>+</strong> to add from Files,<br/>iCloud Drive, or Google Drive</p>
      <button class="gbtn gbtn-primary mt16" id="btnAddEmpty">Add Books</button>
    </div>
  </div>
</div>

<!-- ════════ SEARCH ════════ -->
<div class="tab-screen" id="scrSearch">
  <header class="scr-hdr gbar"><h1 class="scr-title">Search</h1></header>
  <div class="search-container">
    <div class="sinput-wrap glass">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input type="search" class="sinput" id="gSearch" placeholder="Search title, author, ISBN…" enterkeyhint="search"/>
      <button class="sclear hidden" id="btnSClear">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
      </button>
    </div>
    <div class="src-chips">
      <button class="schip active" data-src="Google Books">Google Books</button>
      <button class="schip active" data-src="Open Library">Open Library</button>
      <button class="schip active" data-src="iTunes / Audible">iTunes</button>
      <button class="schip active" data-src="MusicBrainz">MusicBrainz</button>
    </div>
    <div class="sresults" id="sResults"><div class="sph"><p>Search all sources at once<br/>and tap a result to apply it</p></div></div>
  </div>
</div>

<!-- ════════ SETTINGS ════════ -->
<div class="tab-screen" id="scrSettings">
  <header class="scr-hdr gbar"><h1 class="scr-title">Settings</h1></header>
  <div class="settings-scroll">
    <div class="sgroup glass">
      <div class="slabel">Google Drive</div>
      <div class="srow"><span class="srow-label">OAuth Client ID</span></div>
      <input type="text" class="sinp" id="settGDrive" placeholder="Paste your Google OAuth Client ID"/>
      <p class="shint">Required for Google Drive integration. Create one at console.cloud.google.com.</p>
    </div>
    <div class="sgroup glass">
      <div class="slabel">Metadata</div>
      <div class="srow" id="togAutoFetch"><span class="srow-label">Auto-fetch on import</span><div class="toggle on" id="autoFetchToggle"><div class="tog-knob"></div></div></div>
    </div>
    <div class="sgroup glass">
      <div class="slabel">Library</div>
      <button class="srow" id="btnClearLib" style="text-align:left;width:100%;cursor:pointer;background:none;border-top:1px solid var(--g-border);border-left:none;border-right:none;border-bottom:none;font-family:var(--font)"><span class="srow-label danger">Clear All Books</span></button>
    </div>
    <div class="sgroup glass">
      <div class="slabel">About</div>
      <div class="srow"><span class="srow-label">Version</span><span class="srow-val">1.0.0</span></div>
      <div class="srow"><span class="srow-label">Sources</span><span class="srow-val">4 APIs</span></div>
      <div class="srow"><span class="srow-label">Formats</span><span class="srow-val">EPUB · PDF · MP3 · M4B · FLAC · OGG</span></div>
    </div>
  </div>
</div>

<!-- ════════ TAB BAR ════════ -->
<nav class="tab-bar gbar" id="tabBar">
  <button class="tbtn active" data-tab="Library">
    <div class="tab-icon-wrap"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg></div>
    <span>Library</span>
  </button>
  <button class="tbtn" data-tab="Search">
    <div class="tab-icon-wrap"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg></div>
    <span>Search</span>
  </button>
  <button class="tbtn" data-tab="Settings">
    <div class="tab-icon-wrap"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></div>
    <span>Settings</span>
  </button>
</nav>

<!-- ════════ SOURCE PICKER SHEET ════════ -->
<div class="backdrop" id="srcBackdrop"></div>
<div class="bsheet" id="srcSheet">
  <div class="sh-handle"></div>
  <h2 class="sh-title">Add Books</h2>
  <div class="src-opts">
    <button class="src-opt" id="srcLocal">
      <div class="src-icon" style="background:linear-gradient(135deg,#3B82F6,#6366F1)"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg></div>
      <div class="src-info"><span class="src-name">Files / Local Storage</span><span class="src-sub">Browse on-device files</span></div>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity=".4"><polyline points="9 18 15 12 9 6"/></svg>
    </button>
    <button class="src-opt" id="srcICloud">
      <div class="src-icon" style="background:linear-gradient(135deg,#06B6D4,#3B82F6)"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg></div>
      <div class="src-info"><span class="src-name">iCloud Drive</span><span class="src-sub">Open from iCloud</span></div>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity=".4"><polyline points="9 18 15 12 9 6"/></svg>
    </button>
    <button class="src-opt" id="srcGDrive">
      <div class="src-icon" style="background:linear-gradient(135deg,#F59E0B,#EF4444)"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="m12 3-9 15h18z"/><path d="m7.5 12 4.5 7.5"/><path d="m16.5 12-4.5 7.5"/></svg></div>
      <div class="src-info"><span class="src-name">Google Drive</span><span class="src-sub">Sign in and browse Drive</span></div>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity=".4"><polyline points="9 18 15 12 9 6"/></svg>
    </button>
  </div>
  <button class="gbtn" id="btnSheetCancel">Cancel</button>
</div>

<!-- ════════ EDITOR ════════ -->
<div class="editor-scr" id="editorScr">
  <div class="hero" id="eHero">
    <div class="hero-bg" id="eBg"></div>
    <img class="hero-cover" id="eCover" src="" alt="" style="display:none"/>
    <div class="hero-cover-ph" id="eCoverPh"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg><span style="font-size:12px;color:var(--t3)">No cover</span></div>
    <div class="hero-overlay"></div>
    <div class="enav gbar">
      <button class="enav-back" id="btnBack">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="15 18 9 12 15 6"/></svg>Library
      </button>
      <div class="enav-actions">
        <button class="ibtn" id="btnFetch" title="Fetch"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>
        <button class="ibtn ibtn-accent" id="btnSave" title="Save"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg></button>
      </div>
    </div>
    <div class="hero-info">
      <div class="hero-fmt" id="eFormat">EPUB</div>
      <h2 class="hero-title" id="eTitle">—</h2>
      <p class="hero-author" id="eAuthor">—</p>
      <div class="hero-cactions">
        <button class="hcbtn" id="btnCoverChange"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4z"/></svg>Change Cover</button>
        <button class="hcbtn" id="btnCoverSave"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/></svg>Save Cover</button>
      </div>
    </div>
  </div>

  <div class="escroll" id="eScroll">
    <div class="astrip glass" id="aStrip" style="display:none">
      <div class="astat"><span class="ast-val" id="aDur">—</span><span class="ast-lbl">Duration</span></div>
      <div class="adiv"></div>
      <div class="astat"><span class="ast-val" id="aBit">—</span><span class="ast-lbl">Bitrate</span></div>
      <div class="adiv"></div>
      <div class="astat"><span class="ast-val" id="aSR">—</span><span class="ast-lbl">Sample Rate</span></div>
      <div class="adiv"></div>
      <div class="astat"><span class="ast-val" id="aCh">—</span><span class="ast-lbl">Channels</span></div>
    </div>
    <div class="fcard glass">
      <div class="fgroup"><label class="flabel">Title</label><input class="finput" id="fTitle" placeholder="Book title"/></div>
      <div class="fdiv"></div>
      <div class="fgroup"><label class="flabel">Author</label><input class="finput" id="fAuthor" placeholder="Author name"/></div>
      <div class="fdiv"></div>
      <div class="fgroup"><label class="flabel">Narrator</label><input class="finput" id="fNarrator" placeholder="Narrator (audiobooks)"/></div>
    </div>
    <div class="fcard glass">
      <div class="fgroup"><label class="flabel">Series</label><input class="finput" id="fSeries" placeholder="Series name"/></div>
      <div class="fdiv"></div>
      <div class="fgroup"><label class="flabel">Year</label><input class="finput" id="fYear" type="number" placeholder="2024"/></div>
      <div class="fdiv"></div>
      <div class="fgroup"><label class="flabel">Publisher</label><input class="finput" id="fPub" placeholder="Publisher"/></div>
      <div class="fdiv"></div>
      <div class="fgroup"><label class="flabel">Genre</label><input class="finput" id="fGenre" placeholder="Genre"/></div>
    </div>
    <div class="fcard glass">
      <div class="fgroup"><label class="flabel">ISBN</label><input class="finput" id="fISBN" placeholder="ISBN-13" inputmode="numeric"/></div>
      <div class="fdiv"></div>
      <div class="fgroup"><label class="flabel">Language</label><input class="finput" id="fLang" placeholder="en"/></div>
    </div>
    <div class="fcard glass">
      <div class="fgroup"><label class="flabel">Description</label><textarea class="finput ftarea" id="fDesc" rows="5" placeholder="Synopsis / description"></textarea></div>
    </div>
    <div class="epad"></div>
  </div>

  <!-- Results half-sheet -->
  <div class="res-back" id="rBack" style="display:none"></div>
  <div class="res-sheet glass" id="rSheet" style="display:none">
    <div class="sh-handle"></div>
    <div class="res-hdr"><span id="rSheetTitle">Results</span>
      <button class="ibtn" id="btnCloseR"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="rlist" id="rList"></div>
  </div>
</div>

<!-- Toast & loader -->
<div class="toast" id="toast"></div>
<div class="lpill glass" id="lpill" style="display:none"><div class="spin"></div><span id="lmsg">Loading…</span></div>

<script>
'use strict';
// ── State ────────────────────────────────────────────────────────────────────
const S = {
  library: [],
  activeIdx: -1,
  activeTab: 'Library',
  filterFmt: 'all',
  settings: { gDriveId: '', autoFetch: true },
};

// ── Seed demo data ───────────────────────────────────────────────────────────
S.library = [
  { id:1, fileName:'Project Hail Mary.epub', format:'epub', title:'Project Hail Mary', author:'Andy Weir', year:'2021', publisher:'Ballantine Books', genre:'Science Fiction', isbn:'9780593135204', description:'A lone astronaut must save the Earth from disaster in this propulsive sci-fi adventure.', language:'en', coverBase64:null, coverMime:null, narrator:'', series:'', },
  { id:2, fileName:'Dune.epub', format:'epub', title:'Dune', author:'Frank Herbert', year:'1965', publisher:'Chilton Books', genre:'Science Fiction', isbn:'9780441013593', description:'Set in the distant future amidst a feudal interstellar society, Dune tells the story of young Paul Atreides.', language:'en', coverBase64:null, coverMime:null, narrator:'', series:'Dune Chronicles', },
  { id:3, fileName:'Atomic Habits.pdf', format:'pdf', title:'Atomic Habits', author:'James Clear', year:'2018', publisher:'Avery', genre:'Self-Help', isbn:'9780735211292', description:"An easy and proven way to build good habits and break bad ones.", language:'en', coverBase64:null, coverMime:null, narrator:'', series:'', },
  { id:4, fileName:'The Name of the Wind.mp3', format:'mp3', title:'The Name of the Wind', author:'Patrick Rothfuss', year:'2007', publisher:'DAW Books', genre:'Fantasy', isbn:'9780756404079', description:'A heroic symphony of a legend told in three days.', language:'en', coverBase64:null, coverMime:null, narrator:'Nick Podehl', series:'Kingkiller Chronicle', duration:57600, bitrate:256, sampleRate:44100, channels:2, },
  { id:5, fileName:'Sapiens.m4b', format:'m4b', title:'Sapiens', author:'Yuval Noah Harari', year:'2011', publisher:'Harper', genre:'History', isbn:'9780062316097', description:'A brief history of humankind.', language:'en', coverBase64:null, coverMime:null, narrator:'Derek Perkins', series:'', duration:51840, bitrate:128, sampleRate:44100, channels:1, },
  { id:6, fileName:'Foundation.epub', format:'epub', title:'Foundation', author:'Isaac Asimov', year:'1951', publisher:'Gnome Press', genre:'Science Fiction', isbn:'9780553293357', description:'The fall of the Galactic Empire and the rise of a new civilization.', language:'en', coverBase64:null, coverMime:null, narrator:'', series:'Foundation', },
];

// ── DOM ──────────────────────────────────────────────────────────────────────
const $ = id => document.getElementById(id);
const D = {
  scrLib:$('scrLibrary'), scrSearch:$('scrSearch'), scrSettings:$('scrSettings'),
  bookGrid:$('bookGrid'), emptyState:$('emptyState'), filterStrip:$('filterStrip'),
  srcBackdrop:$('srcBackdrop'), srcSheet:$('srcSheet'),
  editorScr:$('editorScr'), eBg:$('eBg'), eCover:$('eCover'), eCoverPh:$('eCoverPh'),
  eFormat:$('eFormat'), eTitle:$('eTitle'), eAuthor:$('eAuthor'),
  aStrip:$('aStrip'), aDur:$('aDur'), aBit:$('aBit'), aSR:$('aSR'), aCh:$('aCh'),
  fTitle:$('fTitle'), fAuthor:$('fAuthor'), fNarrator:$('fNarrator'),
  fSeries:$('fSeries'), fYear:$('fYear'), fPub:$('fPub'), fGenre:$('fGenre'),
  fISBN:$('fISBN'), fLang:$('fLang'), fDesc:$('fDesc'),
  rBack:$('rBack'), rSheet:$('rSheet'), rList:$('rList'), rSheetTitle:$('rSheetTitle'),
  gSearch:$('gSearch'), sResults:$('sResults'), btnSClear:$('btnSClear'),
  settGDrive:$('settGDrive'),
  toast:$('toast'), lpill:$('lpill'), lmsg:$('lmsg'),
};

// ── Toast ─────────────────────────────────────────────────────────────────────
let toastT;
function toast(msg, cls='', ms=3000) {
  D.toast.textContent = msg;
  D.toast.className = `toast${S.activeIdx>=0?' in-editor':''}${cls?' '+cls:''}`;
  requestAnimationFrame(()=>D.toast.classList.add('show'));
  clearTimeout(toastT);
  toastT = setTimeout(()=>D.toast.classList.remove('show'), ms);
}
function showLoad(msg='Loading…'){D.lmsg.textContent=msg;D.lpill.style.display='flex'}
function hideLoad(){D.lpill.style.display='none'}

// ── Tabs ──────────────────────────────────────────────────────────────────────
const TAB_MAP = {Library:'scrLibrary', Search:'scrSearch', Settings:'scrSettings'};
document.querySelectorAll('.tbtn').forEach(b=>{
  b.addEventListener('click',()=>{
    if(b.dataset.tab===S.activeTab) return;
    switchTab(b.dataset.tab);
  });
});
function switchTab(tab) {
  S.activeTab=tab;
  document.querySelectorAll('.tab-screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.tbtn').forEach(b=>b.classList.toggle('active',b.dataset.tab===tab));
  $(TAB_MAP[tab])?.classList.add('active');
}

// Tab buttons routing
$('btnSearch').addEventListener('click',()=>switchTab('Search'));

// ── Source Picker ─────────────────────────────────────────────────────────────
function openPicker(){D.srcBackdrop.classList.add('vis');D.srcSheet.classList.add('open')}
function closePicker(){D.srcBackdrop.classList.remove('vis');D.srcSheet.classList.remove('open')}
$('btnAdd').addEventListener('click',openPicker);
$('btnAddEmpty').addEventListener('click',openPicker);
D.srcBackdrop.addEventListener('click',closePicker);
$('btnSheetCancel').addEventListener('click',closePicker);

// File input
function makeFilePicker() {
  const inp = document.createElement('input');
  inp.type='file'; inp.accept='.epub,.pdf,.mp3,.m4b,.m4a,.flac,.ogg,.opus'; inp.multiple=true;
  inp.onchange = async()=>{
    closePicker();
    const files = Array.from(inp.files||[]);
    if(!files.length) return;
    showLoad(`Importing ${files.length} file${files.length>1?'s':''}…`);
    for(const f of files){
      const fmt = f.name.split('.').pop().toLowerCase();
      const entry = {
        id: Date.now()+Math.random(), fileName:f.name, format:fmt,
        title: guessTitle(f.name), author:'', narrator:'', series:'', year:'',
        publisher:'', genre:'', isbn:'', description:'', language:'',
        coverBase64:null, coverMime:null, duration:null, bitrate:null, sampleRate:null, channels:null,
      };
      // Try to read embedded metadata
      try {
        const ab = await f.arrayBuffer();
        if(fmt==='epub') { Object.assign(entry, await parseEpub(ab, f.name)); }
      } catch(e){}
      S.library.unshift(entry);
      if(S.settings.autoFetch && entry.title) fetchAndEnrich(0);
    }
    hideLoad();
    renderLibrary();
    toast(`Added ${files.length} book${files.length>1?'s':''}`, 'success');
  };
  return inp;
}

$('srcLocal').addEventListener('click',()=>makeFilePicker().click());
$('srcICloud').addEventListener('click',()=>makeFilePicker().click());
$('srcGDrive').addEventListener('click',()=>{
  closePicker();
  if(!S.settings.gDriveId){ toast('Add your Google Client ID in Settings first','',5000); setTimeout(()=>switchTab('Settings'),800); return; }
  toast('Google Drive requires the native app','',4000);
});

// ── EPUB parser (minimal) ─────────────────────────────────────────────────────
async function parseEpub(ab, fileName) {
  try {
    const { ZipReader, BlobReader, TextWriter, BlobWriter } = await import('https://cdn.jsdelivr.net/npm/@zip.js/zip.js@2.7.32/+esm');
    const zr      = new ZipReader(new BlobReader(new Blob([ab])));
    const entries = await zr.getEntries();
    const byName  = {};
    entries.forEach(e=>byName[e.filename]=e);

    const containerEntry = byName['META-INF/container.xml'];
    if(!containerEntry) return {};
    const containerXml = await containerEntry.getData(new TextWriter());
    const opfMatch = containerXml.match(/full-path="([^"]+\.opf)"/i);
    if(!opfMatch) return {};

    const opfEntry = byName[opfMatch[1]];
    if(!opfEntry) return {};
    const opf = await opfEntry.getData(new TextWriter());
    await zr.close();

    const get = tag=>{const m=opf.match(new RegExp(`<dc:${tag}[^>]*>([^<]+)<\/dc:${tag}>','i'`));return m?m[1].trim():''};
    const title       = opf.match(/<dc:title[^>]*>([^<]+)<\/dc:title>/i)?.[1]?.trim() || '';
    const author      = opf.match(/<dc:creator[^>]*>([^<]+)<\/dc:creator>/i)?.[1]?.trim() || '';
    const publisher   = opf.match(/<dc:publisher[^>]*>([^<]+)<\/dc:publisher>/i)?.[1]?.trim() || '';
    const date        = opf.match(/<dc:date[^>]*>([^<]+)<\/dc:date>/i)?.[1]?.trim() || '';
    const description = opf.match(/<dc:description[^>]*>([^<]+)<\/dc:description>/i)?.[1]?.trim() || '';
    const language    = opf.match(/<dc:language[^>]*>([^<]+)<\/dc:language>/i)?.[1]?.trim() || '';
    const identifier  = opf.match(/<dc:identifier[^>]*>([^<]+)<\/dc:identifier>/i)?.[1]?.trim() || '';
    return { title, author, publisher, year:date.slice(0,4), description, language, isbn:identifier };
  } catch { return {}; }
}

// ── Library ───────────────────────────────────────────────────────────────────
const FMT_LABELS = {epub:'EPUB',pdf:'PDF',mp3:'MP3',m4b:'M4B',m4a:'M4A',flac:'FLAC',ogg:'OGG',opus:'OPUS'};
const AUDIO_FMTS = new Set(['mp3','m4b','m4a','flac','ogg','opus']);

function renderLibrary() {
  const filtered = S.filterFmt==='all' ? S.library : S.library.filter(b=>b.format===S.filterFmt);
  D.bookGrid.querySelectorAll('.bcard').forEach(el=>el.remove());
  D.emptyState.style.display = filtered.length ? 'none' : 'flex';
  if(!filtered.length) return;

  const frag = document.createDocumentFragment();
  filtered.forEach((book,i)=>{
    const realIdx = S.library.indexOf(book);
    const card    = document.createElement('div');
    card.className='bcard fu';
    card.style.animationDelay=`${Math.min(i*40,300)}ms`;
    const grad = `cg${i%6}`;
    const coverHtml = book.coverBase64
      ? `<img class="bcover-img" src="data:${book.coverMime||'image/jpeg'};base64,${book.coverBase64}" alt="" loading="lazy"/>`
      : `<div class="bcover-ph ${grad}"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.45)" stroke-width="1.5"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg></div>`;
    card.innerHTML=`<div class="bcover-wrap">${coverHtml}<span class="bfmt-badge fmt-${book.format}">${FMT_LABELS[book.format]||book.format.toUpperCase()}</span></div><div class="btitle">${esc(book.title||book.fileName)}</div><div class="bauthor">${esc(book.author||'—')}</div>`;
    card.addEventListener('click',()=>openEditor(realIdx));
    frag.appendChild(card);
  });
  D.bookGrid.appendChild(frag);
}

// Filter pills
D.filterStrip.addEventListener('click',e=>{
  const p = e.target.closest('.fpill'); if(!p) return;
  D.filterStrip.querySelectorAll('.fpill').forEach(x=>x.classList.remove('active'));
  p.classList.add('active');
  S.filterFmt = p.dataset.fmt;
  renderLibrary();
});

// ── Editor ────────────────────────────────────────────────────────────────────
function openEditor(idx) {
  S.activeIdx = idx;
  populate(S.library[idx]);
  D.editorScr.classList.add('open');
}
function closeEditor() {
  D.editorScr.classList.remove('open');
  closeResults();
  S.activeIdx=-1;
}
$('btnBack').addEventListener('click',closeEditor);

function populate(b) {
  D.eFormat.textContent  = FMT_LABELS[b.format]||b.format?.toUpperCase()||'—';
  D.eTitle.textContent   = b.title  || b.fileName || '—';
  D.eAuthor.textContent  = b.author || '—';

  if(b.coverBase64){
    const src=`data:${b.coverMime||'image/jpeg'};base64,${b.coverBase64}`;
    D.eCover.src=src; D.eCover.style.display='block'; D.eCoverPh.style.display='none';
    D.eBg.style.backgroundImage=`url('${src}')`;
  } else {
    D.eCover.style.display='none'; D.eCoverPh.style.display='flex';
    D.eBg.style.backgroundImage='';
  }

  const isAudio = AUDIO_FMTS.has(b.format);
  D.aStrip.style.display = isAudio?'flex':'none';
  if(isAudio){
    D.aDur.textContent = fmtDur(b.duration);
    D.aBit.textContent = b.bitrate ? `${b.bitrate} kbps`:'—';
    D.aSR.textContent  = b.sampleRate ? `${(b.sampleRate/1000).toFixed(1)} kHz`:'—';
    D.aCh.textContent  = b.channels ? (b.channels===1?'Mono':'Stereo'):'—';
  }

  D.fTitle.value    = b.title||''; D.fAuthor.value   = b.author||'';
  D.fNarrator.value = b.narrator||''; D.fSeries.value  = b.series||'';
  D.fYear.value     = b.year||''; D.fPub.value      = b.publisher||'';
  D.fGenre.value    = b.genre||''; D.fISBN.value    = b.isbn||'';
  D.fLang.value     = b.language||''; D.fDesc.value  = b.description||'';

  D.fTitle.oninput  = ()=>{ D.eTitle.textContent  = D.fTitle.value||'—'; };
  D.fAuthor.oninput = ()=>{ D.eAuthor.textContent = D.fAuthor.value||'—'; };

  D.eScroll.scrollTop = 0;
}

function collectForm() {
  const b = S.library[S.activeIdx]||{};
  return { ...b, title:D.fTitle.value, author:D.fAuthor.value, narrator:D.fNarrator.value,
    series:D.fSeries.value, year:D.fYear.value, publisher:D.fPub.value, genre:D.fGenre.value,
    isbn:D.fISBN.value, language:D.fLang.value, description:D.fDesc.value };
}

$('btnSave').addEventListener('click',()=>{
  if(S.activeIdx<0) return;
  S.library[S.activeIdx] = collectForm();
  renderLibrary();
  toast('Saved!','success');
});

$('btnFetch').addEventListener('click',async()=>{
  const q = D.fTitle.value||D.fAuthor.value;
  if(!q){ toast('Enter a title or author first'); return; }
  showLoad('Searching all sources…');
  try {
    const results = await fetchAll(q);
    hideLoad();
    if(!results.length){ toast('No results found'); return; }
    D.rSheetTitle.textContent=`${results.length} Results`;
    renderResults(results, D.rList, applyResult);
    openResults();
  } catch(e){ hideLoad(); toast(`Search failed: ${e.message}`,'error'); }
});

$('btnCoverChange').addEventListener('click',()=>{
  const inp=document.createElement('input'); inp.type='file'; inp.accept='image/*';
  inp.onchange=async()=>{
    const f=inp.files[0]; if(!f) return;
    const b64=await blobToB64(f);
    const book=S.library[S.activeIdx];
    if(book){ book.coverBase64=b64.split(',')[1]; book.coverMime=f.type; }
    D.eCover.src=b64; D.eCover.style.display='block'; D.eCoverPh.style.display='none';
    D.eBg.style.backgroundImage=`url('${b64}')`;
    toast('Cover updated','success');
  };
  inp.click();
});

$('btnCoverSave').addEventListener('click',()=>{
  const b=S.library[S.activeIdx];
  if(!b?.coverBase64){ toast('No cover to save'); return; }
  const ext=b.coverMime?.includes('png')?'png':'jpg';
  const a=document.createElement('a');
  a.href=`data:${b.coverMime};base64,${b.coverBase64}`;
  a.download=`${(b.title||'cover').replace(/[^a-z0-9]/gi,'_')}.${ext}`;
  a.click(); toast('Cover saved','success');
});

// Results sheet
function openResults(){ D.rBack.style.display='block'; D.rSheet.style.display='flex'; requestAnimationFrame(()=>D.rSheet.classList.add('open')); }
function closeResults(){ D.rSheet.classList.remove('open'); setTimeout(()=>{ D.rBack.style.display='none'; D.rSheet.style.display='none'; },400); }
$('btnCloseR').addEventListener('click',closeResults);
D.rBack.addEventListener('click',closeResults);

async function applyResult(r) {
  closeResults();
  if(r.title)       D.fTitle.value    = r.title;
  if(r.author)      D.fAuthor.value   = r.author;
  if(r.narrator)    D.fNarrator.value = r.narrator;
  if(r.publisher)   D.fPub.value      = r.publisher;
  if(r.year)        D.fYear.value     = r.year;
  if(r.isbn)        D.fISBN.value     = r.isbn;
  if(r.genre)       D.fGenre.value    = r.genre;
  if(r.language)    D.fLang.value     = r.language;
  if(r.description) D.fDesc.value     = r.description;
  D.eTitle.textContent  = D.fTitle.value  || '—';
  D.eAuthor.textContent = D.fAuthor.value || '—';
  if(r.coverUrl){
    showLoad('Fetching cover…');
    try{
      const resp=await fetch(r.coverUrl); const blob=await resp.blob();
      const b64=await blobToB64(blob);
      const book=S.library[S.activeIdx];
      if(book){ book.coverBase64=b64.split(',')[1]; book.coverMime=blob.type; }
      D.eCover.src=b64; D.eCover.style.display='block'; D.eCoverPh.style.display='none';
      D.eBg.style.backgroundImage=`url('${b64}')`;
    } catch{}
    hideLoad();
  }
  toast('Applied!','success');
}

// ── API Fetch ─────────────────────────────────────────────────────────────────
const TIMEOUT=9000;
function ft(url,opts={}){
  const c=new AbortController(); const t=setTimeout(()=>c.abort(),TIMEOUT);
  return fetch(url,{...opts,signal:c.signal}).finally(()=>clearTimeout(t));
}

async function fetchAll(query) {
  const q=encodeURIComponent(query);
  const [g,ol,it,mb]=await Promise.allSettled([fetchGB(q),fetchOL(q),fetchIT(q),fetchMB(q)]);
  return [...(g.status==='fulfilled'?g.value:[]),...(ol.status==='fulfilled'?ol.value:[]),
    ...(it.status==='fulfilled'?it.value:[]),...(mb.status==='fulfilled'?mb.value:[])];
}

async function fetchGB(q){
  try{
    const d=await (await ft(`https://www.googleapis.com/books/v1/volumes?q=${q}&maxResults=5`)).json();
    return (d.items||[]).map(it=>{const v=it.volumeInfo||{};return{source:'Google Books',
      title:v.title||'',author:(v.authors||[]).join(', '),publisher:v.publisher||'',
      year:(v.publishedDate||'').slice(0,4),isbn:(v.industryIdentifiers||[]).find(i=>i.type==='ISBN_13')?.identifier||'',
      description:sh(v.description||''),genre:(v.categories||[]).join(', '),language:v.language||'',
      coverUrl:v.imageLinks?.extraLarge||v.imageLinks?.large||v.imageLinks?.thumbnail||null};});
  }catch{return[]}
}

async function fetchOL(q){
  try{
    const d=await(await ft(`https://openlibrary.org/search.json?q=${q}&limit=5`)).json();
    return(d.docs||[]).slice(0,5).map(doc=>({source:'Open Library',title:doc.title||'',
      author:(doc.author_name||[]).join(', '),publisher:(doc.publisher||[]).join(', ').slice(0,80),
      year:doc.first_publish_year?String(doc.first_publish_year):'',isbn:(doc.isbn||[])[0]||'',
      language:(doc.language||[])[0]||'',genre:(doc.subject||[]).slice(0,3).join(', '),
      coverUrl:doc.cover_i?`https://covers.openlibrary.org/b/id/${doc.cover_i}-L.jpg`:null}));
  }catch{return[]}
}

async function fetchIT(q){
  try{
    const [a,e]=await Promise.allSettled([
      ft(`https://itunes.apple.com/search?term=${q}&media=audiobook&limit=4&entity=audiobook`).then(r=>r.json()),
      ft(`https://itunes.apple.com/search?term=${q}&media=ebook&limit=3&entity=ebook`).then(r=>r.json())]);
    return [...(a.status==='fulfilled'?a.value.results:[]),...(e.status==='fulfilled'?e.value.results:[])].slice(0,6).map(item=>({
      source:'iTunes / Audible',title:item.collectionName||item.trackName||'',author:item.artistName||'',
      narrator:item.authorName||'',publisher:item.publisherName||'',year:(item.releaseDate||'').slice(0,4),
      description:sh(item.description||item.longDescription||''),genre:item.primaryGenreName||'',
      coverUrl:(item.artworkUrl600||item.artworkUrl100||'').replace('100x100bb','600x600bb')}));
  }catch{return[]}
}

async function fetchMB(q){
  try{
    const d=await(await ft(`https://musicbrainz.org/ws/2/release/?query=release:${encodeURIComponent(`"${q}"`)}&limit=5&fmt=json`,
      {headers:{'User-Agent':'BookMetaGrabber/1.0 (test)'}})).json();
    const results=[];
    for(const rel of(d.releases||[]).slice(0,4)){
      let coverUrl=null;
      try{const cr=await ft(`https://coverartarchive.org/release/${rel.id}`,{headers:{Accept:'application/json'}});const crd=await cr.json();coverUrl=crd?.images?.[0]?.image||null;}catch{}
      results.push({source:'MusicBrainz',title:rel.title||'',author:rel['artist-credit']?.map(a=>a.artist?.name).join(', ')||'',year:(rel.date||'').slice(0,4),publisher:rel['label-info']?.[0]?.label?.name||'',coverUrl});
    }
    return results;
  }catch{return[]}
}

async function fetchAndEnrich(idx){
  const b=S.library[idx]; if(!b) return;
  try{
    const results=await fetchAll(b.title||b.author||b.fileName);
    if(!results.length) return;
    const best=results[0];
    if(!b.description&&best.description) b.description=best.description;
    if(!b.genre&&best.genre) b.genre=best.genre;
    if(!b.year&&best.year) b.year=best.year;
    if(!b.coverBase64&&best.coverUrl){
      try{const r=await fetch(best.coverUrl);const bl=await r.blob();const b64=await blobToB64(bl);b.coverBase64=b64.split(',')[1];b.coverMime=bl.type;}catch{}
    }
    renderLibrary();
  }catch{}
}

// ── Result renderer ───────────────────────────────────────────────────────────
function renderResults(results, container, onApply){
  container.innerHTML='';
  const SC={'Google Books':'sg','Open Library':'so','iTunes / Audible':'si','MusicBrainz':'sm'};
  results.forEach((r,i)=>{
    const card=document.createElement('div');
    card.className='rcard fu'; card.style.animationDelay=`${Math.min(i*35,250)}ms`;
    const th=r.coverUrl?`<img class="rthumb" src="${r.coverUrl}" alt="" loading="lazy" onerror="this.style.display='none'"/>`:`<div class="rthumb-ph"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/></svg></div>`;
    card.innerHTML=`${th}<div class="rinfo"><div class="rtitle">${esc(r.title||'—')}</div><div class="rauthor">${esc(r.author||'—')}</div><div class="rmeta">${r.year?`<span style="font-size:11px;color:var(--t3)">${esc(r.year)}</span>`:''}<span class="stag ${SC[r.source]||'sg'}">${esc(r.source)}</span></div></div>`;
    card.addEventListener('click',()=>onApply(r));
    container.appendChild(card);
  });
}

// ── Global Search Tab ─────────────────────────────────────────────────────────
let sdeb;
D.gSearch.addEventListener('input',()=>{
  const q=D.gSearch.value.trim();
  D.btnSClear.classList.toggle('hidden',!q);
  clearTimeout(sdeb);
  if(!q){ D.sResults.innerHTML='<div class="sph"><p>Search all sources at once<br/>and tap a result to apply it</p></div>'; return; }
  sdeb=setTimeout(()=>runSearch(q),600);
});
D.gSearch.addEventListener('keydown',e=>{ if(e.key==='Enter'){ clearTimeout(sdeb); runSearch(D.gSearch.value.trim()); } });
$('btnSClear').addEventListener('click',()=>{ D.gSearch.value=''; D.btnSClear.classList.add('hidden'); D.sResults.innerHTML='<div class="sph"><p>Search all sources at once<br/>and tap a result to apply it</p></div>'; });

async function runSearch(q){
  if(!q) return;
  showLoad('Searching…'); D.sResults.innerHTML='';
  try{
    const results=await fetchAll(q); hideLoad();
    if(!results.length){ D.sResults.innerHTML='<div class="sph"><p>No results found</p></div>'; return; }
    renderResults(results, D.sResults, r=>{
      toast('Open a book to apply metadata','',3000);
    });
  }catch(e){ hideLoad(); D.sResults.innerHTML='<div class="sph"><p>Search failed</p></div>'; }
}

// Source chips (toggle, visual only)
document.querySelectorAll('.schip').forEach(c=>c.addEventListener('click',()=>c.classList.toggle('active')));

// ── Settings ──────────────────────────────────────────────────────────────────
$('togAutoFetch').addEventListener('click',()=>{
  S.settings.autoFetch=!S.settings.autoFetch;
  $('autoFetchToggle').classList.toggle('on',S.settings.autoFetch);
});
$('settGDrive').addEventListener('change',()=>{ S.settings.gDriveId=$('settGDrive').value.trim(); toast('Settings saved','success'); });
$('btnClearLib').addEventListener('click',()=>{
  if(!confirm('Remove all books from library?')) return;
  S.library=[]; S.activeIdx=-1; renderLibrary(); toast('Library cleared');
});

// ── Helpers ───────────────────────────────────────────────────────────────────
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function sh(s){return s.replace(/<[^>]+>/g,'').replace(/\s+/g,' ').trim()}
function guessTitle(n){return n.replace(/\.[^.]+$/,'').replace(/[_\-.]+/g,' ').replace(/\s+/g,' ').trim()}
function fmtDur(s){if(!s) return'—';const h=Math.floor(s/3600),m=Math.floor((s%3600)/60);return h>0?`${h}h ${String(m).padStart(2,'0')}m`:`${m}m`}
function blobToB64(blob){return new Promise((r,j)=>{const fr=new FileReader();fr.onload=()=>r(fr.result);fr.onerror=j;fr.readAsDataURL(blob)})}

// ── Init ──────────────────────────────────────────────────────────────────────
renderLibrary();
// Auto-enrich demo books
setTimeout(async()=>{
  for(let i=0;i<S.library.length;i++){
    if(!S.library[i].coverBase64) {
      await fetchAndEnrich(i);
      await new Promise(r=>setTimeout(r,400));
    }
  }
},500);
</script>
</body>
</html>
