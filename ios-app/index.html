<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#000000" />
  <title>Meta Grabber</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Figtree:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="css/mobile.css" />
</head>
<body>

  <!-- ── Ambient background ── -->
  <div class="bg-stage" aria-hidden="true">
    <div class="orb o1"></div>
    <div class="orb o2"></div>
    <div class="orb o3"></div>
    <div class="noise"></div>
  </div>

  <!-- ── Status bar spacer ── -->
  <div class="status-bar-pad"></div>

  <!-- ════════════════════════════════════
       TAB: LIBRARY
       ════════════════════════════════════ -->
  <div class="tab-screen active" id="screenLibrary">

    <!-- Top bar -->
    <header class="screen-header glass-bar">
      <h1 class="screen-title">Library</h1>
      <div class="header-actions">
        <button class="icon-btn" id="btnSearchLib" aria-label="Search library">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        </button>
        <button class="icon-btn icon-btn-accent" id="btnAddMain" aria-label="Add book">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        </button>
      </div>
    </header>

    <!-- Format filter pills -->
    <div class="filter-strip" id="filterStrip">
      <button class="filter-pill active" data-fmt="all">All</button>
      <button class="filter-pill" data-fmt="epub">EPUB</button>
      <button class="filter-pill" data-fmt="pdf">PDF</button>
      <button class="filter-pill" data-fmt="mp3">MP3</button>
      <button class="filter-pill" data-fmt="m4b">M4B</button>
      <button class="filter-pill" data-fmt="flac">FLAC</button>
      <button class="filter-pill" data-fmt="ogg">OGG</button>
    </div>

    <!-- Book grid -->
    <div class="book-grid" id="bookGrid">
      <!-- Populated by JS -->
      <div class="empty-state" id="emptyState">
        <div class="empty-icon">
          <svg width="52" height="52" viewBox="0 0 48 48" fill="none">
            <circle cx="24" cy="24" r="20" fill="url(#eg)" opacity="0.12"/>
            <path d="M24 14v14M17 21l7-7 7 7" stroke="url(#eg)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 33h24" stroke="url(#eg)" stroke-width="2.5" stroke-linecap="round"/>
            <defs>
              <linearGradient id="eg" x1="10" y1="12" x2="38" y2="38" gradientUnits="userSpaceOnUse">
                <stop stop-color="#60A5FA"/><stop offset="1" stop-color="#A78BFA"/>
              </linearGradient>
            </defs>
          </svg>
        </div>
        <h3>No books yet</h3>
        <p>Tap <strong>+</strong> to add from Files,<br/>iCloud Drive, or Google Drive</p>
        <button class="glass-btn glass-btn-primary mt-16" id="btnAddEmpty">Add Books</button>
      </div>
    </div>
  </div>

  <!-- ════════════════════════════════════
       TAB: SEARCH
       ════════════════════════════════════ -->
  <div class="tab-screen" id="screenSearch">
    <header class="screen-header glass-bar">
      <h1 class="screen-title">Search</h1>
    </header>

    <div class="search-container">
      <div class="search-input-wrap glass-input-wrap">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        <input type="search" class="search-input" id="globalSearchInput"
          placeholder="Search title, author, ISBN…" enterkeyhint="search" />
        <button class="search-clear hidden" id="btnSearchClear">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
        </button>
      </div>

      <div class="source-toggles" id="sourceToggles">
        <button class="source-chip active" data-source="Google Books">Google Books</button>
        <button class="source-chip active" data-source="Open Library">Open Library</button>
        <button class="source-chip active" data-source="iTunes / Audible">iTunes</button>
        <button class="source-chip active" data-source="MusicBrainz">MusicBrainz</button>
      </div>

      <div class="search-results-wrap" id="searchResultsWrap">
        <div class="search-placeholder">
          <p>Search all sources at once<br/>and tap a result to apply it</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ════════════════════════════════════
       TAB: SETTINGS
       ════════════════════════════════════ -->
  <div class="tab-screen" id="screenSettings">
    <header class="screen-header glass-bar">
      <h1 class="screen-title">Settings</h1>
    </header>

    <div class="settings-scroll">
      <div class="settings-group glass-panel">
        <div class="settings-label">Google Drive</div>
        <div class="settings-row">
          <span class="settings-row-label">OAuth Client ID</span>
        </div>
        <input type="text" class="glass-input settings-input" id="settingGDriveId"
          placeholder="Paste your Google OAuth Client ID" />
        <p class="settings-hint">Required for Google Drive integration. Create one at console.cloud.google.com.</p>
      </div>

      <div class="settings-group glass-panel">
        <div class="settings-label">Metadata Sources</div>
        <div class="settings-row toggle-row" id="settingAutoFetch">
          <span class="settings-row-label">Auto-fetch on import</span>
          <div class="toggle active"><div class="toggle-knob"></div></div>
        </div>
      </div>

      <div class="settings-group glass-panel">
        <div class="settings-label">Library</div>
        <button class="settings-row danger-row" id="btnClearLibrary">
          <span class="settings-row-label danger">Clear All Books</span>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/></svg>
        </button>
      </div>

      <div class="settings-group glass-panel">
        <div class="settings-label">About</div>
        <div class="settings-row">
          <span class="settings-row-label">Version</span>
          <span class="settings-row-value">1.0.0</span>
        </div>
        <div class="settings-row">
          <span class="settings-row-label">Sources</span>
          <span class="settings-row-value">4 APIs</span>
        </div>
        <div class="settings-row">
          <span class="settings-row-label">Formats</span>
          <span class="settings-row-value">EPUB · PDF · MP3 · M4B · FLAC · OGG</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ════════════════════════════════════
       BOTTOM TAB BAR
       ════════════════════════════════════ -->
  <nav class="tab-bar glass-bar" role="tablist" id="tabBar">
    <button class="tab-btn active" data-tab="Library" role="tab" aria-selected="true">
      <div class="tab-icon-wrap">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
          <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
          <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
        </svg>
      </div>
      <span>Library</span>
    </button>
    <button class="tab-btn" data-tab="Search" role="tab" aria-selected="false">
      <div class="tab-icon-wrap">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
        </svg>
      </div>
      <span>Search</span>
    </button>
    <button class="tab-btn" data-tab="Settings" role="tab" aria-selected="false">
      <div class="tab-icon-wrap">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
          <circle cx="12" cy="12" r="3"/>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
        </svg>
      </div>
      <span>Settings</span>
    </button>
  </nav>

  <!-- ════════════════════════════════════
       SOURCE PICKER SHEET
       ════════════════════════════════════ -->
  <div class="sheet-backdrop" id="sourcePickerBackdrop"></div>
  <div class="bottom-sheet" id="sourcePickerSheet" role="dialog" aria-label="Add books">
    <div class="sheet-handle"></div>
    <h2 class="sheet-title">Add Books</h2>

    <div class="source-options">
      <button class="source-option-btn" id="srcLocal">
        <div class="source-option-icon" style="background:linear-gradient(135deg,#3B82F6,#6366F1)">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
        </div>
        <div class="source-option-info">
          <span class="source-option-title">Files / Local Storage</span>
          <span class="source-option-sub">Browse on-device files</span>
        </div>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity="0.4"><polyline points="9 18 15 12 9 6"/></svg>
      </button>

      <button class="source-option-btn" id="srcICloud">
        <div class="source-option-icon" style="background:linear-gradient(135deg,#06B6D4,#3B82F6)">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>
        </div>
        <div class="source-option-info">
          <span class="source-option-title">iCloud Drive</span>
          <span class="source-option-sub">Open from iCloud</span>
        </div>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity="0.4"><polyline points="9 18 15 12 9 6"/></svg>
      </button>

      <button class="source-option-btn" id="srcFolder">
        <div class="source-option-icon" style="background:linear-gradient(135deg,#10B981,#06B6D4)">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M3 7a2 2 0 0 1 2-2h4l2 2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
        </div>
        <div class="source-option-info">
          <span class="source-option-title">Folder (audiobooks)</span>
          <span class="source-option-sub">Import directories with audio parts</span>
        </div>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity="0.4"><polyline points="9 18 15 12 9 6"/></svg>
      </button>

      <button class="source-option-btn" id="srcGDrive">
        <div class="source-option-icon" style="background:linear-gradient(135deg,#F59E0B,#EF4444)">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="m12 3-9 15h18z"/><path d="m7.5 12 4.5 7.5"/><path d="m16.5 12-4.5 7.5"/></svg>
        </div>
        <div class="source-option-info">
          <span class="source-option-title">Google Drive</span>
          <span class="source-option-sub">Sign in and browse Drive</span>
        </div>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity="0.4"><polyline points="9 18 15 12 9 6"/></svg>
      </button>
    </div>

    <button class="glass-btn sheet-cancel" id="btnSheetCancel">Cancel</button>
  </div>

  <!-- ════════════════════════════════════
       EDITOR FULL-SCREEN SHEET
       ════════════════════════════════════ -->
  <div class="editor-screen" id="editorScreen">

    <!-- Cover hero -->
    <div class="editor-hero" id="editorHero">
      <div class="hero-blur-bg" id="heroBg"></div>
      <img class="hero-cover" id="heroCover" src="" alt="" />
      <div class="hero-overlay"></div>

      <!-- Nav bar -->
      <div class="editor-nav glass-bar">
        <button class="editor-back" id="btnEditorBack">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="15 18 9 12 15 6"/></svg>
          Library
        </button>
        <div class="editor-nav-actions">
          <button class="icon-btn" id="btnEditorFetch" title="Fetch metadata">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          </button>
          <button class="icon-btn icon-btn-accent" id="btnEditorSave" title="Save">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
          </button>
        </div>
      </div>

      <!-- Hero info overlay -->
      <div class="hero-info">
        <div class="hero-format-badge" id="heroFormat">EPUB</div>
        <h2 class="hero-title" id="heroTitle">—</h2>
        <p class="hero-author" id="heroAuthor">—</p>
        <div class="hero-cover-actions">
          <button class="hero-cover-btn" id="btnHeroCoverChange">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4z"/></svg>
            Change Cover
          </button>
        </div>
      </div>
    </div>

    <!-- Scrollable metadata form -->
    <div class="editor-scroll" id="editorScroll">

      <!-- Audio stats strip -->
      <div class="audio-strip glass-panel" id="audioStrip" style="display:none">
        <div class="audio-stat"><span class="ast-val" id="astDuration">—</span><span class="ast-lbl">Duration</span></div>
        <div class="audio-divider"></div>
        <div class="audio-stat"><span class="ast-val" id="astBitrate">—</span><span class="ast-lbl">Bitrate</span></div>
        <div class="audio-divider"></div>
        <div class="audio-stat"><span class="ast-val" id="astSampleRate">—</span><span class="ast-lbl">Sample Rate</span></div>
        <div class="audio-divider"></div>
        <div class="audio-stat"><span class="ast-val" id="astChannels">—</span><span class="ast-lbl">Channels</span></div>
      </div>

      <!-- Form fields -->
      <div class="form-card glass-panel">
        <div class="field-group">
          <label class="field-label">Title</label>
          <input type="text" class="glass-input" id="fTitle" placeholder="Book title" />
        </div>
        <div class="field-divider"></div>
        <div class="field-group">
          <label class="field-label">Author</label>
          <input type="text" class="glass-input" id="fAuthor" placeholder="Author name" />
        </div>
        <div class="field-divider"></div>
        <div class="field-group">
          <label class="field-label">Narrator</label>
          <input type="text" class="glass-input" id="fNarrator" placeholder="Narrator (audiobooks)" />
        </div>
      </div>

      <div class="form-card glass-panel">
        <div class="field-group">
          <label class="field-label">Series</label>
          <input type="text" class="glass-input" id="fSeries" placeholder="Series name" />
        </div>
        <div class="field-divider"></div>
        <div class="field-group">
          <label class="field-label">Year</label>
          <input type="number" inputmode="numeric" class="glass-input" id="fYear" placeholder="2024" />
        </div>
        <div class="field-divider"></div>
        <div class="field-group">
          <label class="field-label">Publisher</label>
          <input type="text" class="glass-input" id="fPublisher" placeholder="Publisher" />
        </div>
        <div class="field-divider"></div>
        <div class="field-group">
          <label class="field-label">Genre</label>
          <input type="text" class="glass-input" id="fGenre" placeholder="Genre / category" />
        </div>
      </div>

      <div class="form-card glass-panel">
        <div class="field-group">
          <label class="field-label">ISBN</label>
          <input type="text" inputmode="numeric" class="glass-input" id="fISBN" placeholder="ISBN-13" />
        </div>
        <div class="field-divider"></div>
        <div class="field-group">
          <label class="field-label">Language</label>
          <input type="text" class="glass-input" id="fLanguage" placeholder="en" />
        </div>
      </div>

      <div class="form-card glass-panel">
        <div class="field-group">
          <label class="field-label">Description</label>
          <textarea class="glass-input glass-textarea" id="fDescription" rows="5" placeholder="Synopsis / description"></textarea>
        </div>
      </div>

      <div class="editor-bottom-pad"></div>
    </div>

    <!-- Results half-sheet -->
    <div class="results-sheet-backdrop" id="resultsBackdrop" style="display:none"></div>
    <div class="results-half-sheet glass-panel" id="resultsSheet" style="display:none">
      <div class="sheet-handle"></div>
      <div class="results-sheet-header">
        <span id="resultsSheetTitle">Results</span>
        <button class="icon-btn" id="btnCloseResults">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="results-list" id="resultsList"></div>
    </div>

  </div><!-- /editorScreen -->

  <!-- ── Toast ── -->
  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <!-- ── Loading pill ── -->
  <div class="loading-pill glass-panel" id="loadingPill" style="display:none">
    <div class="spinner-sm"></div>
    <span id="loadingMsg">Loading…</span>
  </div>

  <!-- Folder import confirmation modal -->
  <div class="modal-backdrop" id="folderConfirmBackdrop" style="display:none"></div>
  <div class="modal" id="folderConfirm" style="display:none">
    <h3 id="folderConfirmTitle">Import folder</h3>
    <p id="folderConfirmBody">Import as a single file (concatenate parts) or keep as a multi-part audiobook?</p>
    <div class="modal-actions">
      <button class="glass-btn glass-btn-primary" id="folderConfirmConcat">Concatenate & Import</button>
      <button class="glass-btn" id="folderConfirmParts">Import as Parts</button>
      <button class="glass-btn sheet-cancel" id="folderConfirmCancel">Cancel</button>
    </div>
  </div>

  <!-- Concatenation progress modal -->
  <div class="modal-backdrop" id="concatProgressBackdrop" style="display:none"></div>
  <div class="modal" id="concatProgress" style="display:none">
    <h3 id="concatProgressTitle">Concatenating…</h3>
    <div style="margin:12px 0">
      <div style="background:rgba(255,255,255,0.06);height:10px;border-radius:6px;overflow:hidden">
        <div id="concatProgressBar" style="width:0%;height:100%;background:linear-gradient(90deg,#60A5FA,#A78BFA)"></div>
      </div>
      <div style="font-size:13px;color:var(--t3);margin-top:8px" id="concatProgressMsg">Starting…</div>
    </div>
    <div class="modal-actions">
      <button class="glass-btn sheet-cancel" id="concatCancel">Cancel</button>
    </div>
  </div>

  <!-- Parts list in editor -->
  <div class="parts-list-wrap" id="partsListWrap" style="display:none">
    <div class="parts-list-header">Parts</div>
    <div class="parts-list" id="partsList"></div>
  </div>

  <!-- Generic confirm modal -->
  <div class="modal-backdrop" id="confirmBackdrop" style="display:none"></div>
  <div class="modal" id="confirmModal" style="display:none">
    <h3 id="confirmTitle">Confirm</h3>
    <p id="confirmBody">Are you sure?</p>
    <div class="modal-actions">
      <button class="glass-btn glass-btn-primary" id="confirmOk">Yes</button>
      <button class="glass-btn" id="confirmCancel">No</button>
    </div>
  </div>

  <script type="module" src="js/app.js"></script>
</body>
</html>
